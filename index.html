<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NonStop Travels • Application Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Plus Jakarta Sans', system-ui, sans-serif; }
    body { background: #f0f4f8; }

    /* ── Sidebar ── */
    #sidebar { width: 240px; min-height: 100vh; background: #0d6c4e; position: fixed; left: 0; top: 0; z-index: 40; }
    #main-content { margin-left: 240px; }

    /* ── Glass cards ── */
    .card { background: #fff; border-radius: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04); }

    /* ── Status badges ── */
    .badge-approved { background:#dcfce7; color:#166534; }
    .badge-pending  { background:#fef9c3; color:#854d0e; }
    .badge-review   { background:#ffedd5; color:#9a3412; }
    .badge-rejected { background:#fee2e2; color:#991b1b; }

    /* ── Metric accent bars ── */
    .metric-bar { height: 3px; border-radius: 2px; background: #e5e7eb; overflow: hidden; }
    .metric-bar-fill { height: 100%; border-radius: 2px; transition: width 0.8s ease; }

    /* ── Animations ── */
    @keyframes fadeUp { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:none; } }
    .fade-up { animation: fadeUp 0.35s ease forwards; }
    @keyframes modalIn { from { opacity:0; transform:scale(0.96) translateY(20px); } to { opacity:1; transform:none; } }
    .modal-in { animation: modalIn 0.3s cubic-bezier(0.34,1.56,0.64,1) forwards; }

    /* ── Dropzone ── */
    #drop-zone { border: 2px dashed #d1fae5; background: #f0fdf4; border-radius: 12px; transition: all 0.2s; cursor: pointer; }
    #drop-zone.dragover { border-color: #10b981; background: #d1fae5; }
    #drop-zone:hover { border-color: #10b981; }

    /* ── Scrollbar ── */
    ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }

    /* ── Sidebar nav items ── */
    .nav-item { display:flex; align-items:center; gap:12px; padding:10px 20px; border-radius:10px; color:rgba(255,255,255,0.72); font-size:14px; font-weight:500; cursor:pointer; transition:all 0.15s; margin: 2px 12px; }
    .nav-item:hover, .nav-item.active { background:rgba(255,255,255,0.15); color:#fff; }

    /* ── App row ── */
    .app-row { display:flex; align-items:center; padding:14px 20px; background:#fff; border-radius:12px; margin-bottom:8px; cursor:pointer; transition:all 0.15s; border:1px solid #f1f5f9; }
    .app-row:hover { box-shadow:0 4px 16px rgba(0,0,0,0.08); transform:translateY(-1px); border-color:#d1fae5; }

    /* ── Progress bar ── */
    .progress-track { height:6px; background:#e5e7eb; border-radius:3px; overflow:hidden; }
    .progress-fill { height:100%; background: linear-gradient(90deg,#10b981,#34d399); border-radius:3px; }

    /* ── Pulse dot ── */
    .dot-approved { background:#22c55e; } .dot-pending { background:#f59e0b; } .dot-review { background:#f97316; } .dot-rejected { background:#ef4444; }
    .status-dot { width:8px; height:8px; border-radius:50%; display:inline-block; flex-shrink:0; }

    /* ── Sidebar logo ── */
    #sidebar-logo { padding: 24px 20px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }

    /* ── Input focus ── */
    input:focus, textarea:focus, select:focus { outline: none; ring: none; border-color: #10b981 !important; box-shadow: 0 0 0 3px rgba(16,185,129,0.12) !important; }

    /* ── Activity log ── */
    .log-entry { border-left: 2px solid #d1fae5; padding-left: 12px; }
    .log-entry.log-view   { border-color: #93c5fd; }
    .log-entry.log-status { border-color: #6ee7b7; }
    .log-entry.log-delete { border-color: #fca5a5; }
    .log-entry.log-upload { border-color: #a5b4fc; }
    .log-entry.log-note   { border-color: #fcd34d; }

    /* ── Search highlight ── */
    mark { background: #d1fae5; color: #065f46; border-radius: 2px; padding: 0 2px; }

    /* ── Pagination ── */
    .page-btn { min-width: 36px; height: 36px; display:inline-flex; align-items:center; justify-content:center; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.15s; border: 1px solid #e5e7eb; background: #fff; color: #374151; }
    .page-btn:hover { border-color: #10b981; color: #10b981; }
    .page-btn.active { background: #10b981; color: #fff; border-color: #10b981; }
    .page-btn:disabled { opacity: 0.35; cursor: not-allowed; }
  </style>
</head>
<body class="min-h-screen antialiased">

<!-- ══════════════════════════════════════════
     AUTH SCREEN
══════════════════════════════════════════ -->
<div id="auth-screen" class="min-h-screen flex items-center justify-center px-5" style="background:linear-gradient(135deg,#064e35 0%,#0d6c4e 50%,#065f46 100%);">
  <div class="w-full max-w-md">
    <!-- Logo -->
    <div class="text-center mb-10">
      <div class="inline-flex items-center justify-center w-16 h-16 bg-white/20 backdrop-blur rounded-2xl text-3xl mb-4">✈️</div>
      <h1 class="text-3xl font-extrabold text-white tracking-tight">NonStop Travels</h1>
      <p class="text-emerald-300 mt-1 text-sm font-medium">Application Management Hub</p>
    </div>

    <div class="bg-white rounded-2xl shadow-2xl p-8">
      <h2 class="text-xl font-bold text-gray-800 mb-6">Welcome back</h2>
      <div id="auth-error" class="hidden mb-4 px-4 py-3 bg-red-50 border border-red-100 text-red-600 text-sm rounded-xl"></div>
      <div class="space-y-4">
        <div>
          <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1 block">Email</label>
          <input id="email-input" type="email" placeholder="you@example.com"
            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-sm transition-all" autocomplete="email" />
        </div>
        <div>
          <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1 block">Password</label>
          <input id="password-input" type="password" placeholder="••••••••••"
            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-sm transition-all" autocomplete="current-password" />
        </div>
        <button id="login-btn"
          class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 rounded-xl shadow transition-all text-sm mt-2">
          Sign In
        </button>
        <button id="signup-btn"
          class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 rounded-xl transition-all text-sm">
          Create Account
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════
     MAIN APP
══════════════════════════════════════════ -->
<div id="main-app" style="display:none;">

  <!-- SIDEBAR -->
  <aside id="sidebar">
    <div id="sidebar-logo">
      <div class="flex items-center gap-3">
        <span class="text-2xl">✈️</span>
        <div>
          <div class="text-white font-bold text-base leading-tight">NonStop</div>
          <div class="text-emerald-300 text-xs">Travels Hub</div>
        </div>
      </div>
    </div>
    <nav class="mt-6 space-y-1">
      <div class="nav-item active" onclick="showSection('dashboard')">
        <i class="fa-solid fa-house w-4 text-center"></i> Dashboard
      </div>
      <div class="nav-item" onclick="showSection('applications')">
        <i class="fa-solid fa-folder-open w-4 text-center"></i> Applications
      </div>
      <div class="nav-item" id="staff-portal-nav" style="display:none;" onclick="showSection('staff')">
        <i class="fa-solid fa-users-gear w-4 text-center"></i> Staff Portal
      </div>
    </nav>
    <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-white/10">
      <div class="flex items-center gap-3 mb-3 px-2">
        <div class="w-8 h-8 rounded-full bg-emerald-400/30 flex items-center justify-center text-white text-sm font-bold" id="avatar-initials">--</div>
        <div class="flex-1 min-w-0">
          <div id="sidebar-name" class="text-white text-xs font-semibold truncate"></div>
          <div id="sidebar-role" class="text-emerald-300 text-xs capitalize"></div>
        </div>
      </div>
      <button id="logout-btn" class="nav-item w-full text-left" style="margin:0;">
        <i class="fa-solid fa-arrow-right-from-bracket w-4 text-center"></i> Sign Out
      </button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <div id="main-content" class="min-h-screen">

    <!-- TOP BAR -->
    <header class="bg-white border-b border-gray-100 px-8 py-4 flex items-center justify-between sticky top-0 z-30">
      <div>
        <h1 id="page-title" class="text-lg font-bold text-gray-800">Dashboard</h1>
      </div>
      <div class="flex items-center gap-4">
        <span id="role-display" class="px-3 py-1 bg-emerald-50 text-emerald-700 rounded-full text-xs font-semibold capitalize border border-emerald-100"></span>
        <span id="user-display" class="text-sm text-gray-500"></span>
      </div>
    </header>

    <!-- ── DASHBOARD SECTION ── -->
    <section id="section-dashboard" class="px-8 py-8">
      <!-- Hero greeting -->
      <div class="card p-8 mb-6 flex flex-col sm:flex-row sm:items-center justify-between gap-6 fade-up" style="background:linear-gradient(135deg,#f0fdf4,#dcfce7);">
        <div>
          <h2 class="text-3xl font-extrabold text-gray-800" id="greeting-text">Good morning</h2>
          <p class="text-gray-500 mt-1 text-sm" id="active-apps-text">Loading your applications…</p>
        </div>
        <button id="new-app-btn"
          class="flex items-center gap-2 bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-xl font-semibold shadow transition-all text-sm whitespace-nowrap">
          <i class="fa-solid fa-plus"></i> New Application
        </button>
      </div>

      <!-- Metrics -->
      <div id="metrics-grid" class="grid grid-cols-2 lg:grid-cols-4 gap-5 mb-8"></div>

      <!-- Two columns -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Recent applications -->
        <div class="lg:col-span-2 card p-6 fade-up">
          <div class="flex items-center justify-between mb-5">
            <h3 class="font-bold text-gray-800">Recent Applications</h3>
            <button onclick="showSection('applications')" class="text-emerald-600 text-sm font-medium hover:underline">View all →</button>
          </div>
          <div id="recent-apps-list"></div>
        </div>

        <!-- Info panel -->
        <div class="space-y-5">
          <!-- Approval rate -->
          <div class="card p-6 fade-up">
            <div class="text-4xl font-extrabold text-emerald-600 mb-1" id="approval-rate-pct">—%</div>
            <div class="text-gray-500 text-sm mb-3">Approval Rate</div>
            <div class="progress-track"><div class="progress-fill" id="approval-rate-bar" style="width:0%"></div></div>
          </div>
          <!-- Enterprise shield -->
          <div class="card p-6 fade-up" style="background:linear-gradient(135deg,#f0fdf4,#fff);">
            <div class="w-12 h-12 bg-emerald-100 rounded-xl flex items-center justify-center text-emerald-600 text-xl mb-4">
              <i class="fa-solid fa-shield-halved"></i>
            </div>
            <div class="font-bold text-gray-800 mb-3">Enterprise-Grade Protection</div>
            <ul class="space-y-2">
              <li class="flex items-center gap-2 text-sm text-gray-600"><i class="fa-solid fa-check text-emerald-500 text-xs"></i> No public URLs</li>
              <li class="flex items-center gap-2 text-sm text-gray-600"><i class="fa-solid fa-check text-emerald-500 text-xs"></i> Files stored outside web root</li>
              <li class="flex items-center gap-2 text-sm text-gray-600"><i class="fa-solid fa-check text-emerald-500 text-xs"></i> Access logged + audited</li>
              <li class="flex items-center gap-2 text-sm text-gray-600"><i class="fa-solid fa-check text-emerald-500 text-xs"></i> Role-based access control</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- ── APPLICATIONS SECTION ── -->
    <section id="section-applications" class="px-8 py-8 hidden">
      <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4">
        <div>
          <h2 class="text-2xl font-bold text-gray-800">Applications</h2>
          <p class="text-sm text-gray-500 mt-0.5" id="apps-count-label">Loading…</p>
        </div>
        <div class="flex items-center gap-3">
          <select id="status-filter" class="px-4 py-2 bg-white border border-gray-200 rounded-xl text-sm text-gray-600 cursor-pointer transition-all">
            <option value="">All Statuses</option>
            <option value="pending">Pending</option>
            <option value="review">Review</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
          </select>
          <button id="new-app-btn-2"
            class="flex items-center gap-2 bg-orange-500 hover:bg-orange-600 text-white px-5 py-2 rounded-xl font-semibold shadow transition-all text-sm">
            <i class="fa-solid fa-plus"></i> New Application
          </button>
        </div>
      </div>
      <!-- Search bar -->
      <div class="relative mb-5">
        <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-sm pointer-events-none"></i>
        <input id="search-input" type="text" placeholder="Search by name or destination…"
          class="w-full pl-10 pr-4 py-3 bg-white border border-gray-200 rounded-xl text-sm transition-all shadow-sm" />
        <button id="search-clear" class="hidden absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 text-sm">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div id="applications-grid" class="space-y-3"></div>
      <!-- Pagination -->
      <div id="pagination-bar" class="flex items-center justify-between mt-6 hidden">
        <span id="pagination-info" class="text-xs text-gray-400"></span>
        <div id="pagination-btns" class="flex items-center gap-1.5"></div>
      </div>
    </section>

    <!-- ── STAFF SECTION ── -->
    <section id="section-staff" class="px-8 py-8 hidden">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-bold text-gray-800">Staff Portal</h2>
          <p class="text-sm text-gray-500 mt-0.5">Manage all applicants and review activity</p>
        </div>
        <button id="staff-refresh-btn" onclick="refreshStaffPortal()" class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-xl text-sm text-gray-600 hover:border-emerald-400 transition-all">
          <i class="fa-solid fa-rotate-right"></i> Refresh
        </button>
      </div>

      <!-- Tabs -->
      <div class="flex gap-1 mb-6 bg-gray-100 p-1 rounded-xl w-fit">
        <button id="tab-applicants-btn" onclick="switchStaffTab('applicants')"
          class="px-5 py-2 rounded-lg text-sm font-semibold transition-all bg-white text-gray-800 shadow-sm">
          <i class="fa-solid fa-users mr-2"></i>All Applicants
        </button>
        <button id="tab-log-btn" onclick="switchStaffTab('log')"
          class="px-5 py-2 rounded-lg text-sm font-semibold transition-all text-gray-500 hover:text-gray-700">
          <i class="fa-solid fa-clock-rotate-left mr-2"></i>Activity Log
        </button>
      </div>

      <!-- ── APPLICANTS TAB ── -->
      <div id="staff-tab-applicants">
        <!-- Search + filter -->
        <div class="flex items-center gap-3 mb-5">
          <div class="relative flex-1">
            <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-sm pointer-events-none"></i>
            <input id="staff-search" type="text" placeholder="Search applicant name, destination…"
              class="w-full pl-10 pr-4 py-3 bg-white border border-gray-200 rounded-xl text-sm transition-all shadow-sm" />
          </div>
          <select id="staff-status-filter" class="px-4 py-3 bg-white border border-gray-200 rounded-xl text-sm text-gray-600 transition-all">
            <option value="">All Statuses</option>
            <option value="pending">Pending</option>
            <option value="review">Review</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
          </select>
        </div>
        <div id="staff-applicants-list" class="space-y-3"></div>
        <!-- Staff pagination -->
        <div id="staff-pagination-bar" class="flex items-center justify-between mt-6 hidden">
          <span id="staff-pagination-info" class="text-xs text-gray-400"></span>
          <div id="staff-pagination-btns" class="flex items-center gap-1.5"></div>
        </div>
      </div>

      <!-- ── ACTIVITY LOG TAB ── -->
      <div id="staff-tab-log" class="hidden">
        <div class="flex items-center gap-3 mb-5">
          <div class="relative flex-1 max-w-xs">
            <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-sm pointer-events-none"></i>
            <input id="log-search" type="text" placeholder="Search log…"
              class="w-full pl-10 pr-4 py-2.5 bg-white border border-gray-200 rounded-xl text-sm transition-all" />
          </div>
          <select id="log-action-filter" class="px-4 py-2.5 bg-white border border-gray-200 rounded-xl text-sm text-gray-600 transition-all">
            <option value="">All Actions</option>
            <option value="view">View</option>
            <option value="status_update">Status Update</option>
            <option value="delete">Delete</option>
            <option value="upload">Upload</option>
            <option value="note">Note Added</option>
          </select>
        </div>
        <div id="activity-log-container" class="card p-6">
          <div class="text-center text-gray-400 py-8">
            <i class="fa-solid fa-spinner fa-spin text-2xl mb-3 text-gray-300 block"></i>
            <p class="text-sm">Loading activity log…</p>
          </div>
        </div>
      </div>
    </section>

  </div><!-- /main-content -->
</div><!-- /main-app -->

<!-- ══════════════════════════════════════════
     NEW APPLICATION MODAL
══════════════════════════════════════════ -->
<div id="new-app-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4" style="background:rgba(0,0,0,0.4); backdrop-filter:blur(4px);">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md modal-in">
    <div class="flex items-center justify-between px-6 py-5 border-b border-gray-100">
      <h3 class="font-bold text-gray-800 text-lg">New Application</h3>
      <button onclick="closeNewAppModal()" class="text-gray-400 hover:text-gray-600 text-xl"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="px-6 py-5 space-y-4">
      <div>
        <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1 block">Applicant Name *</label>
        <input id="new-app-name" type="text" placeholder="Full name" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-sm transition-all" />
      </div>
      <div>
        <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1 block">Destination</label>
        <input id="new-app-destination" type="text" placeholder="e.g. France, Schengen" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-sm transition-all" />
      </div>
      <div>
        <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1 block">Travel Date</label>
        <input id="new-app-date" type="date" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-sm transition-all" />
      </div>
      <div>
        <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1 block">Notes</label>
        <textarea id="new-app-notes" rows="3" placeholder="Any additional info…" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-sm transition-all resize-none"></textarea>
      </div>
    </div>
    <div class="px-6 py-4 border-t border-gray-100 flex gap-3">
      <button onclick="closeNewAppModal()" class="flex-1 py-3 rounded-xl border border-gray-200 text-gray-600 text-sm font-semibold hover:bg-gray-50 transition-all">Cancel</button>
      <button id="create-app-btn" onclick="createApplication()" class="flex-1 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold transition-all shadow">Create Application</button>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════
     DETAIL MODAL
══════════════════════════════════════════ -->
<div id="detail-modal" class="hidden fixed inset-0 z-50 flex items-start justify-center p-4 pt-12 overflow-y-auto" style="background:rgba(0,0,0,0.45); backdrop-filter:blur(4px);">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl modal-in mb-8">
    <!-- Header -->
    <div class="flex items-center justify-between px-6 py-5 border-b border-gray-100">
      <h3 id="modal-title" class="font-bold text-gray-800 text-lg"></h3>
      <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-xl"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <!-- App info -->
    <div id="app-info" class="px-6 py-5 border-b border-gray-100 grid grid-cols-2 gap-4 text-sm"></div>

    <!-- Status update (staff only) -->
    <div id="status-update-section" class="px-6 py-4 border-b border-gray-100 hidden">
      <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2 block">Update Status</label>
      <div class="flex gap-2 flex-wrap">
        <button onclick="updateApplicationStatus('pending')"   class="px-4 py-2 rounded-xl text-xs font-semibold bg-yellow-50 text-yellow-700 border border-yellow-200 hover:bg-yellow-100 transition-all">Pending</button>
        <button onclick="updateApplicationStatus('review')"    class="px-4 py-2 rounded-xl text-xs font-semibold bg-orange-50 text-orange-700 border border-orange-200 hover:bg-orange-100 transition-all">Review</button>
        <button onclick="updateApplicationStatus('approved')"  class="px-4 py-2 rounded-xl text-xs font-semibold bg-green-50 text-green-700 border border-green-200 hover:bg-green-100 transition-all">Approved</button>
        <button onclick="updateApplicationStatus('rejected')"  class="px-4 py-2 rounded-xl text-xs font-semibold bg-red-50 text-red-700 border border-red-200 hover:bg-red-100 transition-all">Rejected</button>
      </div>
    </div>

    <!-- Documents -->
    <div class="px-6 py-5 border-b border-gray-100">
      <div class="flex items-center justify-between mb-3">
        <h4 class="font-semibold text-gray-700 text-sm">Documents</h4>
        <span id="doc-count" class="text-xs text-gray-400"></span>
      </div>
      <div id="drop-zone" onclick="document.getElementById('upload-file-input').click()"
        class="flex flex-col items-center justify-center py-8 mb-3 text-center">
        <i class="fa-solid fa-cloud-arrow-up text-emerald-400 text-2xl mb-2"></i>
        <p class="text-sm text-gray-500">Drop files here or <span class="text-emerald-600 font-medium">click to upload</span></p>
        <p class="text-xs text-gray-400 mt-1">PDF, JPG, PNG up to 10MB</p>
        <input id="upload-file-input" type="file" class="hidden" multiple accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileUpload(event)" />
      </div>
      <div id="documents-container" class="space-y-2"></div>
    </div>

    <!-- Notes -->
    <div class="px-6 py-5">
      <h4 class="font-semibold text-gray-700 text-sm mb-3">Notes</h4>
      <div id="notes-container" class="space-y-3 mb-4 max-h-48 overflow-y-auto"></div>
      <div class="flex gap-2">
        <textarea id="note-textarea" rows="2" placeholder="Add a note…"
          class="flex-1 px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-sm transition-all resize-none"></textarea>
        <button id="add-note-btn" onclick="addNote()"
          class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl text-sm font-semibold transition-all self-end">
          Add
        </button>
      </div>
    </div>

    <!-- Footer actions -->
    <div class="px-6 py-4 border-t border-gray-100 flex justify-between items-center">
      <button id="delete-app-btn" onclick="deleteApplication()"
        class="flex items-center gap-2 text-red-500 hover:text-red-700 text-sm font-medium transition-all hidden">
        <i class="fa-solid fa-trash-can"></i> Delete Application
      </button>
      <button onclick="closeModal()" class="px-5 py-2 rounded-xl border border-gray-200 text-gray-600 text-sm font-semibold hover:bg-gray-50 transition-all">Close</button>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════
     JAVASCRIPT
══════════════════════════════════════════ -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  function waitForSupabase(cb) {
    if (typeof supabase !== 'undefined') cb();
    else setTimeout(() => waitForSupabase(cb), 100);
  }

  waitForSupabase(() => {
    const sb = supabase.createClient(
      'https://lveejxxuvwikbitdbmbw.supabase.co',
      'sb_publishable_5wqWoM5FlCNJDNRhxgMFdA_9vzgwd6U'
    );

    let currentUser    = null;
    let currentProfile = null;
    let selectedAppId  = null;
    let allApplications = [];

    const $ = id => document.getElementById(id);

    // ══════════════════════════════════════
    // 1. AUTH HELPERS
    // ══════════════════════════════════════
    function showAuthError(msg) {
      const el = $('auth-error');
      el.textContent = msg;
      el.classList.remove('hidden');
    }

    $('login-btn').addEventListener('click', async () => {
      $('auth-error').classList.add('hidden');
      const email = $('email-input').value.trim();
      const password = $('password-input').value;
      if (!email || !password) return showAuthError('Please enter email and password.');
      $('login-btn').textContent = 'Signing in…';
      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      $('login-btn').textContent = 'Sign In';
      if (error) return showAuthError(error.message);
      await bootApp(data.user);
    });

    $('signup-btn').addEventListener('click', async () => {
      $('auth-error').classList.add('hidden');
      const email = $('email-input').value.trim();
      const password = $('password-input').value;
      if (!email || !password) return showAuthError('Please enter email and password.');
      if (password.length < 6) return showAuthError('Password must be at least 6 characters.');
      $('signup-btn').textContent = 'Creating account…';
      const { data, error } = await sb.auth.signUp({ email, password });
      $('signup-btn').textContent = 'Create Account';
      if (error) return showAuthError(error.message);
      if (data.session) {
        await bootApp(data.user);
      } else {
        showAuthError('Account created! Please confirm your email before signing in.');
      }
    });

    [$('email-input'), $('password-input')].forEach(el =>
      el.addEventListener('keydown', e => { if (e.key === 'Enter') $('login-btn').click(); })
    );

    $('logout-btn').addEventListener('click', async () => {
      await sb.auth.signOut();
      currentUser = null; currentProfile = null;
      allApplications = []; allLogs = [];
      searchQuery = ''; currentPage = 1;
      $('auth-error').classList.add('hidden');
      $('email-input').value = ''; $('password-input').value = '';
      // Reset sidebar so next user gets clean state
      $('staff-portal-nav').style.display = 'none';
      $('new-app-btn').style.display = '';
      $('new-app-btn-2').style.display = '';
      $('auth-screen').style.display = '';
      $('main-app').style.display = 'none';
    });

    // ══════════════════════════════════════
    // 2. BOOT / PROFILE
    // ══════════════════════════════════════
    async function bootApp(user) {
      currentUser = user;
      $('auth-screen').style.display = 'none';
      $('main-app').style.display = 'block';
      await loadUserProfile();
      await loadAllApplications();
      renderDashboard();
      showSection('dashboard');
    }

    async function loadUserProfile() {
      const { data, error } = await sb
        .from('profiles')
        .select('*')
        .eq('id', currentUser.id)
        .single();

      if (error || !data) {
        // Fallback: derive from email
        currentProfile = { full_name: currentUser.email.split('@')[0], role: 'applicant' };
      } else {
        currentProfile = data;
      }

      const name = currentProfile.full_name || currentUser.email;
      const role = currentProfile.role || 'applicant';
      const initials = name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0,2);

      $('user-display').textContent = currentUser.email;
      $('role-display').textContent = role;
      $('sidebar-name').textContent = name;
      $('sidebar-role').textContent = role;
      $('avatar-initials').textContent = initials;

      // Greeting
      const hour = new Date().getHours();
      const greet = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
      $('greeting-text').textContent = `${greet}, ${name.split(' ')[0]}`;

      const isStaffRole = role === 'staff' || role === 'admin';
      // Staff: show portal nav, hide New Application button
      $('staff-portal-nav').style.display = isStaffRole ? '' : 'none';
      $('new-app-btn').style.display   = isStaffRole ? 'none' : '';
      $('new-app-btn-2').style.display = isStaffRole ? 'none' : '';
    }

    // ══════════════════════════════════════
    // 3. APPLICATIONS
    // ══════════════════════════════════════
    async function loadAllApplications() {
      const isStaff = currentProfile?.role === 'staff' || currentProfile?.role === 'admin';
      // Join profiles to get applicant name/email for staff view
      let query = sb.from('applications')
        .select('*, profiles(full_name, email)')
        .order('created_at', { ascending: false });

      // Applicants only see their own
      if (!isStaff) {
        query = query.eq('user_id', currentUser.id);
      }

      const { data, error } = await query;
      if (error) { console.error('loadAllApplications:', error); return; }
      allApplications = data || [];
    }

    function renderDashboard() {
      renderMetrics();
      renderRecentApps();
      renderApplicationsGrid();
      // Keep staff applicant list in sync if it was rendered
      if (currentProfile?.role === 'staff' || currentProfile?.role === 'admin') {
        renderStaffApplicants();
      }
    }

    // ══════════════════════════════════════
    // 4. METRICS
    // ══════════════════════════════════════
    function renderMetrics() {
      const total    = allApplications.length;
      const approved = allApplications.filter(a => a.status === 'approved').length;
      const pending  = allApplications.filter(a => a.status === 'pending').length;
      const rejected = allApplications.filter(a => a.status === 'rejected').length;
      const rate     = total > 0 ? Math.round((approved / total) * 100) : 0;

      $('metrics-grid').innerHTML = [
        metricCard('Total',    total,    'fa-folder-open', '#10b981', '#f0fdf4'),
        metricCard('Approved', approved, 'fa-circle-check','#3b82f6', '#eff6ff'),
        metricCard('Pending',  pending,  'fa-clock',       '#f59e0b', '#fffbeb'),
        metricCard('Rejected', rejected, 'fa-circle-xmark','#ef4444', '#fef2f2'),
      ].join('');

      $('approval-rate-pct').textContent = rate + '%';
      setTimeout(() => {
        const bar = $('approval-rate-bar');
        if (bar) bar.style.width = rate + '%';
      }, 200);

      const active = allApplications.filter(a => a.status === 'pending' || a.status === 'review').length;
      $('active-apps-text').innerHTML = `You have <strong class="text-emerald-600">${active} active application${active !== 1 ? 's' : ''}</strong>`;
    }

    function metricCard(label, value, icon, color, bg) {
      return `
        <div class="card p-5 fade-up">
          <div class="flex items-center justify-between mb-3">
            <span class="w-9 h-9 rounded-xl flex items-center justify-center text-sm" style="background:${bg}; color:${color}">
              <i class="fa-solid ${icon}"></i>
            </span>
            <span class="text-xs font-medium text-gray-400">${label}</span>
          </div>
          <div class="text-3xl font-extrabold text-gray-800">${value}</div>
        </div>`;
    }

    // ══════════════════════════════════════
    // RECENT APPS (dashboard)
    // ══════════════════════════════════════
    function renderRecentApps() {
      const recent = allApplications.slice(0, 5);
      if (!recent.length) {
        $('recent-apps-list').innerHTML = '<p class="text-gray-400 text-sm text-center py-8">No applications yet.</p>';
        return;
      }
      $('recent-apps-list').innerHTML = recent.map(a => appRow(a)).join('');
    }

    // ══════════════════════════════════════
    // SEARCH + PAGINATION STATE
    // ══════════════════════════════════════
    const PAGE_SIZE = 10;
    let currentPage = 1;
    let searchQuery = '';

    function getFilteredApps() {
      const filter = $('status-filter')?.value || '';
      const q = searchQuery.toLowerCase();
      return allApplications.filter(a => {
        const matchStatus = !filter || a.status === filter;
        const matchSearch = !q ||
          (a.applicant_name || '').toLowerCase().includes(q) ||
          (a.destination || '').toLowerCase().includes(q);
        return matchStatus && matchSearch;
      });
    }

    // ══════════════════════════════════════
    // APPLICATIONS GRID
    // ══════════════════════════════════════
    function renderApplicationsGrid() {
      const filtered = getFilteredApps();
      const totalPages = Math.ceil(filtered.length / PAGE_SIZE);
      if (currentPage > totalPages) currentPage = 1;

      const start = (currentPage - 1) * PAGE_SIZE;
      const page = filtered.slice(start, start + PAGE_SIZE);

      $('apps-count-label').textContent = `${filtered.length} application${filtered.length !== 1 ? 's' : ''}`;

      if (!filtered.length) {
        $('applications-grid').innerHTML = `
          <div class="card p-12 text-center text-gray-400">
            <i class="fa-solid fa-folder-open text-4xl mb-3 text-gray-200"></i>
            <p class="font-medium">No applications found.</p>
          </div>`;
        $('pagination-bar').classList.add('hidden');
        return;
      }

      $('applications-grid').innerHTML = page.map(app => appRow(app, searchQuery)).join('');

      // Pagination
      if (totalPages > 1) {
        $('pagination-bar').classList.remove('hidden');
        $('pagination-info').textContent = `Showing ${start + 1}–${Math.min(start + PAGE_SIZE, filtered.length)} of ${filtered.length}`;
        renderPaginationBtns(totalPages);
      } else {
        $('pagination-bar').classList.add('hidden');
      }
    }

    function renderPaginationBtns(totalPages) {
      let html = `<button class="page-btn" ${currentPage===1?'disabled':''} onclick="goPage(${currentPage-1})"><i class="fa-solid fa-chevron-left text-xs"></i></button>`;
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || Math.abs(i - currentPage) <= 1) {
          html += `<button class="page-btn ${i===currentPage?'active':''}" onclick="goPage(${i})">${i}</button>`;
        } else if (Math.abs(i - currentPage) === 2) {
          html += `<span class="text-gray-400 text-xs px-1">…</span>`;
        }
      }
      html += `<button class="page-btn" ${currentPage===totalPages?'disabled':''} onclick="goPage(${currentPage+1})"><i class="fa-solid fa-chevron-right text-xs"></i></button>`;
      $('pagination-btns').innerHTML = html;
    }

    window.goPage = function(p) { currentPage = p; renderApplicationsGrid(); };

    // XSS sanitizer — escape all user-sourced content before innerHTML
    function sanitize(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function highlight(text, query) {
      if (!query) return text || '';
      const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      return (text || '').replace(new RegExp(escaped, 'gi'), m => `<mark>${m}</mark>`);
    }

    function appRow(app, query = '') {
      const statusClass = { approved:'badge-approved', pending:'badge-pending', review:'badge-review', rejected:'badge-rejected' }[app.status] || 'badge-pending';
      const dotClass    = { approved:'dot-approved',   pending:'dot-pending',   review:'dot-review',   rejected:'dot-rejected'   }[app.status] || 'dot-pending';
      const date = app.created_at ? new Date(app.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : '';
      const appNum = app.id ? `#${String(app.id).slice(-4).toUpperCase()}` : '#—';
      const nameHl = highlight(sanitize(app.applicant_name) || 'Untitled', query);
      const destHl = highlight(sanitize(app.destination), query);

      return `
        <div class="app-row" onclick="openApplicationModal('${app.id}')">
          <div class="w-10 h-10 rounded-xl bg-emerald-50 flex items-center justify-center text-emerald-500 mr-4 flex-shrink-0">
            <i class="fa-solid fa-file-lines text-sm"></i>
          </div>
          <div class="flex-1 min-w-0">
            <div class="font-semibold text-gray-800 text-sm">${appNum} — ${nameHl}</div>
            <div class="text-xs text-gray-400 mt-0.5">${date}${destHl ? ` · <span class="text-gray-500">${destHl}</span>` : ''}</div>
          </div>
          <div class="flex items-center gap-3 ml-4">
            <div class="flex items-center gap-1.5">
              <span class="status-dot ${dotClass}"></span>
              <span class="text-xs font-medium ${statusClass} px-2.5 py-1 rounded-full capitalize">${app.status || 'pending'}</span>
            </div>
            <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
          </div>
        </div>`;
    }

    // Search wiring
    $('search-input').addEventListener('input', function() {
      searchQuery = this.value.trim();
      $('search-clear').classList.toggle('hidden', !searchQuery);
      currentPage = 1;
      renderApplicationsGrid();
    });
    $('search-clear').addEventListener('click', function() {
      $('search-input').value = '';
      searchQuery = '';
      this.classList.add('hidden');
      currentPage = 1;
      renderApplicationsGrid();
    });
    $('status-filter')?.addEventListener('change', () => { currentPage = 1; renderApplicationsGrid(); });

    // ══════════════════════════════════════
    // CREATE APPLICATION
    // ══════════════════════════════════════
    window.openNewAppModal = function() {
      $('new-app-modal').classList.remove('hidden');
    };
    window.closeNewAppModal = function() {
      $('new-app-modal').classList.add('hidden');
      ['new-app-name','new-app-destination','new-app-date','new-app-notes'].forEach(id => $(id).value = '');
    };

    window.createApplication = async function() {
      const name = $('new-app-name').value.trim();
      if (!name) return alert('Applicant name is required.');
      $('create-app-btn').textContent = 'Creating…';
      $('create-app-btn').disabled = true;

      const { data, error } = await sb.from('applications').insert({
        user_id: currentUser.id,
        applicant_name: name,
        destination: $('new-app-destination').value.trim() || null,
        travel_date: $('new-app-date').value || null,
        notes: $('new-app-notes').value.trim() || null,
        status: 'pending',
      }).select().single();

      $('create-app-btn').textContent = 'Create Application';
      $('create-app-btn').disabled = false;

      if (error) return alert('Error creating application: ' + error.message);
      closeNewAppModal();
      await loadAllApplications();
      renderDashboard();
    };

    $('new-app-btn').addEventListener('click', openNewAppModal);
    $('new-app-btn-2').addEventListener('click', openNewAppModal);

    // ══════════════════════════════════════
    // 7. DETAIL MODAL
    // ══════════════════════════════════════
    window.openApplicationModal = async function(appId) {
      selectedAppId = appId;
      const app = allApplications.find(a => String(a.id) === String(appId));
      if (!app) return;

      $('modal-title').textContent = `#${String(app.id).slice(-4).toUpperCase()} — ${app.applicant_name || 'Application'}`;  // textContent, safe

      const date = app.created_at ? new Date(app.created_at).toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'}) : '—';
      const safeStatus = ['pending','review','approved','rejected'].includes(app.status) ? app.status : 'pending';
      const isStaffModal = currentProfile?.role === 'staff' || currentProfile?.role === 'admin';
      const applicantEmail = sanitize(app.profiles?.email || '');
      $('app-info').innerHTML = `
        <div><div class="text-xs text-gray-400 font-medium mb-1">Applicant</div><div class="font-semibold text-gray-800">${sanitize(app.applicant_name) || '—'}</div></div>
        <div><div class="text-xs text-gray-400 font-medium mb-1">Status</div><span class="badge-${safeStatus} px-2.5 py-1 rounded-full text-xs font-semibold capitalize">${safeStatus}</span></div>
        <div><div class="text-xs text-gray-400 font-medium mb-1">Destination</div><div class="font-semibold text-gray-800">${sanitize(app.destination) || '—'}</div></div>
        <div><div class="text-xs text-gray-400 font-medium mb-1">Travel Date</div><div class="font-semibold text-gray-800">${sanitize(app.travel_date) || '—'}</div></div>
        ${isStaffModal && applicantEmail ? `<div><div class="text-xs text-gray-400 font-medium mb-1">Applicant Email</div><div class="font-semibold text-emerald-700">${applicantEmail}</div></div>` : ''}
        <div class="${isStaffModal && applicantEmail ? '' : 'col-span-2'}"><div class="text-xs text-gray-400 font-medium mb-1">Submitted</div><div class="text-gray-800">${date}</div></div>
      `;

      // Show status controls and delete only for staff
      const isStaff = currentProfile?.role === 'staff' || currentProfile?.role === 'admin';
      $('status-update-section').classList.toggle('hidden', !isStaff);
      $('delete-app-btn').classList.toggle('hidden', !isStaff);

      $('detail-modal').classList.remove('hidden');
      // Log staff view access
      if (isStaff) {
        await logActivity('view', appId, `Viewed application for "${app.applicant_name || appId}"`);
      }
      await Promise.all([loadDocuments(appId), loadNotes(appId)]);
    };

    window.closeModal = function() {
      $('detail-modal').classList.add('hidden');
      selectedAppId = null;
    };

    // ══════════════════════════════════════
    // ACTIVITY LOGGING
    // ══════════════════════════════════════
    async function logActivity(action, appId, detail = '') {
      try {
        await sb.from('activity_logs').insert({
          staff_user_id: currentUser.id,
          staff_email: currentUser.email,
          application_id: appId,
          action,
          detail,
        });
      } catch(e) { /* silent — logging should never break the app */ }
    }

    // ══════════════════════════════════════
    // 9. UPDATE STATUS
    // ══════════════════════════════════════
    window.updateApplicationStatus = async function(newStatus) {
      if (!selectedAppId) return;
      const app = allApplications.find(a => String(a.id) === String(selectedAppId));
      const prevStatus = app?.status || 'unknown';

      const { error } = await sb.from('applications')
        .update({ status: newStatus, updated_at: new Date().toISOString() })
        .eq('id', selectedAppId);
      if (error) return alert('Error updating status: ' + error.message);

      await logActivity('status_update', selectedAppId,
        `Changed status from "${prevStatus}" to "${newStatus}" for "${app?.applicant_name || selectedAppId}"`);

      // ── Email notification to applicant ──────────────────────────────────
      // Calls a Supabase Edge Function. Create it in your Supabase project:
      // supabase/functions/notify-applicant/index.ts
      // It receives { applicant_email, applicant_name, new_status, app_id }
      // and sends the email via Resend / SendGrid / SMTP.
      try {
        const applicantEmail = app?.profiles?.email || null;
        if (applicantEmail) {
          await sb.functions.invoke('notify-applicant', {
            body: {
              applicant_email: applicantEmail,
              applicant_name:  app?.applicant_name || 'Applicant',
              new_status:      newStatus,
              prev_status:     prevStatus,
              app_id:          selectedAppId,
            }
          });
        }
      } catch(e) {
        console.warn('Email notification failed (non-critical):', e.message);
      }

      await loadAllApplications();
      renderDashboard();
      if (currentProfile?.role === 'staff' || currentProfile?.role === 'admin') {
        renderStaffApplicants();
      }
      openApplicationModal(selectedAppId);
    };

    // ══════════════════════════════════════
    // DELETE APPLICATION
    // ══════════════════════════════════════
    window.deleteApplication = async function() {
      if (!selectedAppId) return;
      if (!confirm('Are you sure you want to delete this application? This cannot be undone.')) return;
      const app = allApplications.find(a => String(a.id) === String(selectedAppId));
      const appName = app?.applicant_name || selectedAppId;
      await logActivity('delete', selectedAppId, `Deleted application for "${appName}"`);
      const { error } = await sb.from('applications').delete().eq('id', selectedAppId);
      if (error) return alert('Error deleting: ' + error.message);
      closeModal();
      await loadAllApplications();
      renderDashboard();
      if (currentProfile?.role === 'staff' || currentProfile?.role === 'admin') {
        renderStaffApplicants();
      }
    };

    // ══════════════════════════════════════
    // 5. DOCUMENTS
    // ══════════════════════════════════════
    async function loadDocuments(appId) {
      const { data, error } = await sb.storage.from('documents').list(`${appId}/`, { sortBy:{ column:'created_at', order:'desc' } });
      const container = $('documents-container');
      if (error || !data?.length) {
        $('doc-count').textContent = '0 files';
        container.innerHTML = '<p class="text-xs text-gray-400 text-center py-2">No documents uploaded yet.</p>';
        return;
      }
      $('doc-count').textContent = `${data.length} file${data.length !== 1 ? 's' : ''}`;
      container.innerHTML = data.map(file => `
        <div class="flex items-center gap-3 px-4 py-3 bg-gray-50 rounded-xl">
          <i class="fa-solid fa-file text-emerald-400 text-sm"></i>
          <span class="flex-1 text-sm text-gray-700 truncate">${sanitize(file.name)}</span>
          <button onclick="downloadFile('${appId}','${file.name}')" class="text-emerald-600 hover:text-emerald-800 text-xs font-medium transition-all">Download</button>
        </div>`).join('');
    }

    window.handleFileUpload = async function(event) {
      if (!selectedAppId) return;
      const files = Array.from(event.target.files);
      if (!files.length) return;

      for (const file of files) {
        const path = `${selectedAppId}/${Date.now()}_${file.name}`;
        const { error } = await sb.storage.from('documents').upload(path, file);
        if (error) alert(`Upload failed for ${file.name}: ${error.message}`);
      }
      await logActivity('upload', selectedAppId, `Uploaded ${files.length} file(s): ${files.map(f=>f.name).join(', ')}`);
      await loadDocuments(selectedAppId);
      event.target.value = '';
    };

    window.downloadFile = async function(appId, filename) {
      const { data, error } = await sb.storage.from('documents').download(`${appId}/${filename}`);
      if (error) return alert('Download failed: ' + error.message);
      const url = URL.createObjectURL(data);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    };

    // Drag & drop
    const dz = $('drop-zone');
    dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
    dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
    dz.addEventListener('drop', e => {
      e.preventDefault(); dz.classList.remove('dragover');
      const fakeEvent = { target: { files: e.dataTransfer.files, value: '' } };
      handleFileUpload(fakeEvent);
    });

    // ══════════════════════════════════════
    // 6. NOTES
    // ══════════════════════════════════════
    async function loadNotes(appId) {
      const { data, error } = await sb.from('notes')
        .select('*')
        .eq('application_id', appId)
        .order('created_at', { ascending: true });

      const container = $('notes-container');
      if (error || !data?.length) {
        container.innerHTML = '<p class="text-xs text-gray-400 text-center py-2">No notes yet.</p>';
        return;
      }
      container.innerHTML = data.map(note => {
        const date = new Date(note.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
        return `
          <div class="bg-gray-50 rounded-xl px-4 py-3">
            <div class="text-xs text-gray-400 mb-1">${date}</div>
            <div class="text-sm text-gray-700">${sanitize(note.content)}</div>
          </div>`;
      }).join('');
      container.scrollTop = container.scrollHeight;
    }

    window.addNote = async function() {
      const content = $('note-textarea').value.trim();
      if (!content || !selectedAppId) return;
      $('add-note-btn').textContent = '…';
      const { error } = await sb.from('notes').insert({
        application_id: selectedAppId,
        user_id: currentUser.id,
        content,
      });
      $('add-note-btn').textContent = 'Add';
      if (error) return alert('Error adding note: ' + error.message);
      await logActivity('note', selectedAppId, `Added note: "${content.slice(0, 60)}${content.length > 60 ? '…' : ''}"`);
      $('note-textarea').value = '';
      await loadNotes(selectedAppId);
    };

    // ══════════════════════════════════════
    // STAFF PORTAL — APPLICANT LIST
    // ══════════════════════════════════════
    let staffPage = 1;
    const STAFF_PAGE_SIZE = 15;
    let currentStaffTab = 'applicants';

    window.switchStaffTab = function(tab) {
      currentStaffTab = tab;
      $('staff-tab-applicants').classList.toggle('hidden', tab !== 'applicants');
      $('staff-tab-log').classList.toggle('hidden', tab !== 'log');
      $('tab-applicants-btn').className = tab === 'applicants'
        ? 'px-5 py-2 rounded-lg text-sm font-semibold transition-all bg-white text-gray-800 shadow-sm'
        : 'px-5 py-2 rounded-lg text-sm font-semibold transition-all text-gray-500 hover:text-gray-700';
      $('tab-log-btn').className = tab === 'log'
        ? 'px-5 py-2 rounded-lg text-sm font-semibold transition-all bg-white text-gray-800 shadow-sm'
        : 'px-5 py-2 rounded-lg text-sm font-semibold transition-all text-gray-500 hover:text-gray-700';
      if (tab === 'log') loadActivityLog();
      if (tab === 'applicants') renderStaffApplicants();
    };

    window.refreshStaffPortal = async function() {
      await loadAllApplications();
      renderStaffApplicants();
      if (currentStaffTab === 'log') loadActivityLog();
    };

    function getStaffFilteredApps() {
      const q = ($('staff-search')?.value || '').toLowerCase();
      const statusF = $('staff-status-filter')?.value || '';
      return allApplications.filter(a => {
        const matchStatus = !statusF || a.status === statusF;
        const matchQ = !q ||
          (a.applicant_name || '').toLowerCase().includes(q) ||
          (a.destination || '').toLowerCase().includes(q) ||
          (a.profiles?.email || '').toLowerCase().includes(q);
        return matchStatus && matchQ;
      });
    }

    function renderStaffApplicants() {
      const filtered = getStaffFilteredApps();
      const totalPages = Math.max(1, Math.ceil(filtered.length / STAFF_PAGE_SIZE));
      if (staffPage > totalPages) staffPage = 1;
      const start = (staffPage - 1) * STAFF_PAGE_SIZE;
      const page = filtered.slice(start, start + STAFF_PAGE_SIZE);
      const list = $('staff-applicants-list');

      if (!filtered.length) {
        list.innerHTML = `<div class="card p-12 text-center text-gray-400">
          <i class="fa-solid fa-users text-4xl mb-3 text-gray-200"></i>
          <p class="font-medium">No applicants found.</p></div>`;
        $('staff-pagination-bar').classList.add('hidden');
        return;
      }

      list.innerHTML = page.map(app => staffAppRow(app)).join('');

      if (totalPages > 1) {
        $('staff-pagination-bar').classList.remove('hidden');
        $('staff-pagination-info').textContent =
          `Showing ${start + 1}–${Math.min(start + STAFF_PAGE_SIZE, filtered.length)} of ${filtered.length}`;
        renderStaffPaginationBtns(totalPages);
      } else {
        $('staff-pagination-bar').classList.add('hidden');
      }
    }

    function staffAppRow(app) {
      const safeStatus = ['pending','review','approved','rejected'].includes(app.status) ? app.status : 'pending';
      const dotClass = { approved:'dot-approved', pending:'dot-pending', review:'dot-review', rejected:'dot-rejected' }[safeStatus];
      const badgeClass = { approved:'badge-approved', pending:'badge-pending', review:'badge-review', rejected:'badge-rejected' }[safeStatus];
      const date = app.created_at ? new Date(app.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : '';
      const appNum = `#${String(app.id).slice(-4).toUpperCase()}`;
      const applicantEmail = sanitize(app.profiles?.email || '');
      const applicantName = sanitize(app.applicant_name || 'Untitled');
      const dest = sanitize(app.destination || '');

      return `
        <div class="app-row" onclick="openApplicationModal('${app.id}')">
          <div class="w-10 h-10 rounded-xl bg-emerald-50 flex items-center justify-center text-emerald-500 mr-4 flex-shrink-0">
            <i class="fa-solid fa-user text-sm"></i>
          </div>
          <div class="flex-1 min-w-0">
            <div class="font-semibold text-gray-800 text-sm">${appNum} — ${applicantName}</div>
            <div class="text-xs text-gray-400 mt-0.5">
              ${applicantEmail ? `<span class="text-gray-500">${applicantEmail}</span> · ` : ''}${date}${dest ? ` · ${dest}` : ''}
            </div>
          </div>
          <div class="flex items-center gap-3 ml-4">
            <div class="flex items-center gap-1.5">
              <span class="status-dot ${dotClass}"></span>
              <span class="text-xs font-medium ${badgeClass} px-2.5 py-1 rounded-full capitalize">${safeStatus}</span>
            </div>
            <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
          </div>
        </div>`;
    }

    function renderStaffPaginationBtns(totalPages) {
      let html = `<button class="page-btn" ${staffPage===1?'disabled':''} onclick="goStaffPage(${staffPage-1})"><i class="fa-solid fa-chevron-left text-xs"></i></button>`;
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || Math.abs(i - staffPage) <= 1) {
          html += `<button class="page-btn ${i===staffPage?'active':''}" onclick="goStaffPage(${i})">${i}</button>`;
        } else if (Math.abs(i - staffPage) === 2) {
          html += `<span class="text-gray-400 text-xs px-1">…</span>`;
        }
      }
      html += `<button class="page-btn" ${staffPage===totalPages?'disabled':''} onclick="goStaffPage(${staffPage+1})"><i class="fa-solid fa-chevron-right text-xs"></i></button>`;
      $('staff-pagination-btns').innerHTML = html;
    }

    window.goStaffPage = function(p) { staffPage = p; renderStaffApplicants(); };

    // Wire staff search + filter
    document.addEventListener('input', e => {
      if (e.target.id === 'staff-search') { staffPage = 1; renderStaffApplicants(); }
    });
    document.addEventListener('change', e => {
      if (e.target.id === 'staff-status-filter') { staffPage = 1; renderStaffApplicants(); }
    });

    // ══════════════════════════════════════
    // ACTIVITY LOG
    // ══════════════════════════════════════
    let allLogs = [];

    window.loadActivityLog = async function() {
      const container = $('activity-log-container');
      container.innerHTML = `<div class="text-center py-8 text-gray-400"><i class="fa-solid fa-spinner fa-spin text-2xl mb-3 text-gray-300 block"></i><p class="text-sm">Loading…</p></div>`;

      const { data, error } = await sb.from('activity_logs')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(200);

      if (error) {
        container.innerHTML = `<p class="text-sm text-red-500 text-center py-6">Failed to load log: ${error.message}</p>`;
        return;
      }
      allLogs = data || [];
      renderActivityLog();
    };

    function renderActivityLog() {
      const q = ($('log-search')?.value || '').toLowerCase();
      const actionFilter = $('log-action-filter')?.value || '';
      const logs = allLogs.filter(l => {
        const matchAction = !actionFilter || l.action === actionFilter;
        const matchQ = !q ||
          (l.staff_email || '').toLowerCase().includes(q) ||
          (l.detail || '').toLowerCase().includes(q) ||
          (l.action || '').toLowerCase().includes(q);
        return matchAction && matchQ;
      });

      const container = $('activity-log-container');
      if (!logs.length) {
        container.innerHTML = `<p class="text-sm text-gray-400 text-center py-8">No activity log entries found.</p>`;
        return;
      }

      const actionIcon = { view:'fa-eye', status_update:'fa-pen-to-square', delete:'fa-trash-can', upload:'fa-cloud-arrow-up', note:'fa-note-sticky' };
      const actionLabel = { view:'Viewed', status_update:'Status Updated', delete:'Deleted', upload:'Uploaded File', note:'Note Added' };
      const actionColor = { view:'log-view', status_update:'log-status', delete:'log-delete', upload:'log-upload', note:'log-note' };

      container.innerHTML = `
        <div class="space-y-4">
          ${logs.map(log => {
            const date = new Date(log.created_at).toLocaleString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit'});
            const icon = actionIcon[log.action] || 'fa-circle-info';
            const label = actionLabel[log.action] || log.action;
            const cls = actionColor[log.action] || '';
            return `
              <div class="log-entry ${cls} py-1">
                <div class="flex items-start gap-3">
                  <span class="w-7 h-7 rounded-lg bg-gray-100 flex items-center justify-center text-gray-500 flex-shrink-0 mt-0.5">
                    <i class="fa-solid ${icon} text-xs"></i>
                  </span>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 flex-wrap">
                      <span class="text-sm font-semibold text-gray-800">${sanitize(log.staff_email) || 'Unknown'}</span>
                      <span class="text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-500 font-medium">${label}</span>
                    </div>
                    <div class="text-sm text-gray-600 mt-0.5">${sanitize(log.detail) || '—'}</div>
                    <div class="text-xs text-gray-400 mt-1">${date}</div>
                  </div>
                </div>
              </div>`;
          }).join('')}
        </div>`;
    }

    // ══════════════════════════════════════
    // 8. SECTION SWITCHING
    // ══════════════════════════════════════
    window.showSection = function(name) {
      ['dashboard','applications','staff'].forEach(s => {
        $(`section-${s}`).classList.toggle('hidden', s !== name);
      });
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      const navMap = { dashboard: 0, applications: 1, staff: 2 };
      const items = document.querySelectorAll('.nav-item');
      if (items[navMap[name]]) items[navMap[name]].classList.add('active');
      const titles = { dashboard:'Dashboard', applications:'Applications', staff:'Staff Portal' };
      $('page-title').textContent = titles[name] || '';
      if (name === 'applications') renderApplicationsGrid();
      if (name === 'staff') {
        renderStaffApplicants();  // always render applicant list on tab open
        // reset to applicants tab each time
        switchStaffTab('applicants');
      }
    };

    // Log filter listeners
    $('log-search')?.addEventListener('input', renderActivityLog);
    $('log-action-filter')?.addEventListener('change', renderActivityLog);

    // Close modals on backdrop click
    $('new-app-modal').addEventListener('click', e => { if (e.target === $('new-app-modal')) closeNewAppModal(); });
    $('detail-modal').addEventListener('click', e => { if (e.target === $('detail-modal')) closeModal(); });

    // ══════════════════════════════════════
    // INIT
    // ══════════════════════════════════════
    async function init() {
      const { data: { session } } = await sb.auth.getSession();
      if (session) {
        await bootApp(session.user);
      }

      sb.auth.onAuthStateChange(async (_event, session) => {
        if (session && !currentUser) {
          await bootApp(session.user);
        } else if (!session && currentUser) {
          currentUser = null;
          $('auth-screen').style.display = '';
          $('main-app').style.display = 'none';
        }
      });
    }

    init();
  });
});
</script>
</body>
</html>