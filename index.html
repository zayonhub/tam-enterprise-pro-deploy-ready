<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NonStop Travels - Application Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * { font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background-color: #f0f4f8; }
        .sidebar { width: 240px; background: linear-gradient(180deg, #0d6c4e 0%, #10b981 100%); }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-review { background-color: #ffedd5; color: #9a3412; }
        .status-approved { background-color: #d1fae5; color: #065f46; }
        .status-rejected { background-color: #fee2e2; color: #991b1b; }
        .log-view { border-left-color: #3b82f6; }
        .log-status_update { border-left-color: #10b981; }
        .log-delete { border-left-color: #ef4444; }
        .log-upload { border-left-color: #8b5cf6; }
        .log-note { border-left-color: #f59e0b; }
        .log-assign { border-left-color: #059669; }
        .log-edit { border-left-color: #f97316; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        .drag-active { border-color: #10b981 !important; background-color: #ecfdf5 !important; }
        mark { background-color: #a7f3d0; padding: 0 2px; border-radius: 2px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #10b981; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #059669; }
    </style>
</head>
<body class="text-gray-800 antialiased">

<!-- ===== AUTH SCREEN ===== -->
<div id="authScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-emerald-50 to-teal-100 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 fade-in">
        <div class="text-center mb-8">
            <div class="text-5xl mb-4">‚úàÔ∏è</div>
            <h1 class="text-3xl font-bold text-emerald-800">NonStop Travels</h1>
            <p class="text-gray-500 mt-2">Application Management System</p>
        </div>
        <div id="authError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm"></div>
        <form id="authForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                <input type="email" id="authEmail" required autocomplete="email"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none transition">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <div class="relative">
                    <input type="password" id="authPassword" required minlength="6" autocomplete="current-password"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none transition pr-10">
                    <button type="button" onclick="togglePw('authPassword','pwIcon1')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                        <i id="pwIcon1" class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            <!-- Signup only fields -->
            <div id="signupFields" class="hidden space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                    <div class="relative">
                        <input type="password" id="authConfirmPassword" autocomplete="new-password"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none transition pr-10">
                        <button type="button" onclick="togglePw('authConfirmPassword','pwIcon2')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                            <i id="pwIcon2" class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Security Question</label>
                    <select id="securityQuestion" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none">
                        <option value="">Select a question...</option>
                        <option>What is your mother's maiden name?</option>
                        <option>What was the name of your first pet?</option>
                        <option>In what city were you born?</option>
                        <option>What was the name of your first school?</option>
                        <option>Who was your favorite teacher?</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Security Answer</label>
                    <input type="text" id="securityAnswer" autocomplete="off" placeholder="Your answer"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Referral Code <span class="text-gray-400">(Optional)</span></label>
                    <input type="text" id="referralCode" maxlength="8" style="text-transform:uppercase" placeholder="8 characters"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none font-mono">
                </div>
            </div>
            <button type="submit" id="authSubmitBtn"
                class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 rounded-lg transition flex items-center justify-center gap-2">
                <span id="authBtnText">Sign In</span>
                <i class="fas fa-arrow-right"></i>
            </button>
        </form>
        <div class="mt-6 text-center">
            <button onclick="toggleAuthMode()" id="authToggleBtn" class="text-emerald-600 hover:text-emerald-700 font-medium text-sm">Create Account</button>
        </div>
    </div>
</div>

<!-- ===== MAIN APP ===== -->
<div id="mainApp" class="hidden min-h-screen">

    <!-- Sidebar -->
    <aside class="sidebar fixed left-0 top-0 h-full text-white flex flex-col z-50">
        <div class="p-6 border-b border-emerald-500/30">
            <div class="flex items-center gap-3">
                <span class="text-3xl">‚úàÔ∏è</span>
                <div>
                    <h2 class="font-bold text-lg leading-tight">NonStop</h2>
                    <p class="text-xs text-emerald-100">Travels</p>
                </div>
            </div>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="showSection('dashboard')" id="navDashboard"
                class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 transition text-left bg-white/10">
                <i class="fas fa-home w-5"></i><span>Dashboard</span>
            </button>
            <button onclick="showSection('applications')" id="navApplications"
                class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 transition text-left">
                <i class="fas fa-folder-open w-5"></i><span>Applications</span>
            </button>
            <button onclick="showSection('staff')" id="navStaff"
                class="hidden w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 transition text-left">
                <i class="fas fa-user-shield w-5"></i><span>Staff Portal</span>
            </button>
        </nav>
        <div class="p-4 border-t border-emerald-500/30">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center font-bold text-lg" id="userAvatar">U</div>
                <div class="flex-1 min-w-0">
                    <p class="font-medium truncate" id="sidebarName">User</p>
                    <span class="inline-block px-2 py-0.5 bg-emerald-400/30 rounded text-xs capitalize" id="sidebarRole">Applicant</span>
                </div>
            </div>
            <button onclick="handleLogout()" class="w-full flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-white/10 transition text-sm text-emerald-100">
                <i class="fas fa-sign-out-alt"></i> Sign Out
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="ml-[240px] min-h-screen">
        <header class="sticky top-0 bg-white border-b border-gray-200 px-8 py-4 flex items-center justify-between z-40">
            <h1 id="pageTitle" class="text-2xl font-bold text-gray-800">Dashboard</h1>
            <div class="flex items-center gap-4">
                <span class="text-gray-600 text-sm" id="headerEmail"></span>
                <span id="headerRole" class="px-3 py-1 rounded-full text-xs font-semibold capitalize bg-emerald-100 text-emerald-700">Applicant</span>
            </div>
        </header>

        <div class="p-8">

            <!-- DASHBOARD -->
            <div id="dashboardSection" class="fade-in">
                <div class="bg-gradient-to-r from-emerald-600 to-teal-600 rounded-2xl p-8 text-white mb-8 shadow-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-emerald-100 mb-1" id="greetingText">Good morning,</p>
                            <h2 class="text-3xl font-bold mb-4" id="heroName">User</h2>
                            <div class="flex items-center gap-2 text-emerald-100">
                                <i class="fas fa-file-alt"></i>
                                <span id="activeAppsCount">0 active applications</span>
                            </div>
                        </div>
                        <button onclick="openNewAppModal()" id="newAppBtn"
                            class="bg-white text-emerald-700 px-6 py-3 rounded-lg font-semibold hover:bg-emerald-50 transition shadow-md flex items-center gap-2">
                            <i class="fas fa-plus"></i> New Application
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 card-hover transition">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-blue-100 text-blue-600 rounded-lg"><i class="fas fa-folder text-xl"></i></div>
                            <span class="text-2xl font-bold" id="metricTotal">0</span>
                        </div>
                        <p class="text-gray-600 text-sm">Total Applications</p>
                        <div class="mt-3 h-2 bg-gray-100 rounded-full"><div class="h-full bg-blue-500 rounded-full w-full"></div></div>
                    </div>
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 card-hover transition">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-green-100 text-green-600 rounded-lg"><i class="fas fa-check-circle text-xl"></i></div>
                            <span class="text-2xl font-bold" id="metricApproved">0</span>
                        </div>
                        <p class="text-gray-600 text-sm">Approved</p>
                        <div class="mt-3 h-2 bg-gray-100 rounded-full overflow-hidden"><div id="progressApproved" class="h-full bg-green-500 rounded-full transition-all duration-500" style="width:0%"></div></div>
                    </div>
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 card-hover transition">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-yellow-100 text-yellow-600 rounded-lg"><i class="fas fa-clock text-xl"></i></div>
                            <span class="text-2xl font-bold" id="metricPending">0</span>
                        </div>
                        <p class="text-gray-600 text-sm">Pending</p>
                        <div class="mt-3 h-2 bg-gray-100 rounded-full overflow-hidden"><div id="progressPending" class="h-full bg-yellow-500 rounded-full transition-all duration-500" style="width:0%"></div></div>
                    </div>
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 card-hover transition">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-red-100 text-red-600 rounded-lg"><i class="fas fa-times-circle text-xl"></i></div>
                            <span class="text-2xl font-bold" id="metricRejected">0</span>
                        </div>
                        <p class="text-gray-600 text-sm">Rejected</p>
                        <div class="mt-3 h-2 bg-gray-100 rounded-full overflow-hidden"><div id="progressRejected" class="h-full bg-red-500 rounded-full transition-all duration-500" style="width:0%"></div></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-bold">Recent Applications</h3>
                            <button onclick="showSection('applications')" class="text-emerald-600 hover:text-emerald-700 text-sm font-medium">View all ‚Üí</button>
                        </div>
                        <div id="recentAppsList" class="space-y-3"></div>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                            <h3 class="text-lg font-bold mb-4">Approval Rate</h3>
                            <div class="text-center">
                                <div class="text-5xl font-bold text-emerald-600 mb-2" id="approvalRate">0%</div>
                                <div class="w-full h-3 bg-gray-100 rounded-full overflow-hidden mb-2">
                                    <div id="approvalProgress" class="h-full bg-gradient-to-r from-emerald-500 to-teal-500 rounded-full transition-all duration-500" style="width:0%"></div>
                                </div>
                                <p class="text-sm text-gray-500">Based on total applications</p>
                            </div>
                        </div>
                        <div id="referralCard" class="bg-gradient-to-br from-emerald-50 to-teal-50 rounded-2xl border border-emerald-200 p-6">
                            <h3 class="text-lg font-bold text-emerald-800 mb-3">Your Referral Code</h3>
                            <div class="bg-white rounded-lg p-4 border-2 border-dashed border-emerald-300 mb-3">
                                <code class="text-2xl font-mono font-bold text-emerald-700 tracking-wider block text-center" id="referralCodeDisplay">--------</code>
                            </div>
                            <button onclick="copyReferralCode()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-lg transition flex items-center justify-center gap-2">
                                <i class="fas fa-copy"></i> Copy Code
                            </button>
                            <p class="text-xs text-emerald-600 mt-3 text-center">Share this code with friends!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- APPLICATIONS -->
            <div id="applicationsSection" class="hidden fade-in">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h2 class="text-xl font-bold">Applications</h2>
                            <p class="text-sm text-gray-500 mt-1"><span id="appsCount">0</span> applications</p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <select id="statusFilter" onchange="filterApplications()"
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm">
                                <option value="all">All Statuses</option>
                                <option value="pending">Pending</option>
                                <option value="review">Review</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                            <div class="relative">
                                <input type="text" id="searchInput" oninput="filterApplications()" placeholder="Search applications..."
                                    class="pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm w-64">
                                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <button onclick="clearSearch()" id="clearSearchBtn" class="hidden absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <button onclick="openNewAppModal()" id="newAppBtn2"
                                class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg transition flex items-center gap-2 text-sm font-medium">
                                <i class="fas fa-plus"></i> New Application
                            </button>
                        </div>
                    </div>
                    <div id="applicationsList" class="space-y-3"></div>
                    <div id="emptyState" class="hidden text-center py-12">
                        <div class="text-6xl text-gray-300 mb-4">üìÅ</div>
                        <h3 class="text-lg font-medium text-gray-600 mb-2">No applications found</h3>
                        <p class="text-gray-500 text-sm">Try adjusting your search or filter</p>
                    </div>
                    <div id="pagination" class="flex items-center justify-between mt-6 pt-6 border-t border-gray-100">
                        <span class="text-sm text-gray-500" id="paginationInfo">Showing 0-0 of 0</span>
                        <div class="flex gap-2" id="paginationBtns"></div>
                    </div>
                </div>
            </div>

            <!-- STAFF PORTAL -->
            <div id="staffSection" class="hidden fade-in">
                <div class="flex gap-1 bg-gray-100 p-1 rounded-lg mb-6 w-fit">
                    <button onclick="switchStaffTab('applicants')" id="tabApplicants"
                        class="px-6 py-2 rounded-md text-sm font-medium bg-white text-emerald-700 shadow-sm">All Applicants</button>
                    <button onclick="switchStaffTab('log')" id="tabLog"
                        class="px-6 py-2 rounded-md text-sm font-medium text-gray-600 hover:text-gray-800">Activity Log</button>
                </div>

                <div id="applicantsTab" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h2 class="text-xl font-bold" id="staffViewTitle">All Applicants</h2>
                            <p class="text-sm text-gray-500 mt-1"><span id="staffAppsCount">0</span> applications</p>
                        </div>
                        <div class="flex gap-3">
                            <select id="staffStatusFilter" onchange="filterStaffApplications()"
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm">
                                <option value="all">All Statuses</option>
                                <option value="pending">Pending</option>
                                <option value="review">Review</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                            <div class="relative">
                                <input type="text" id="staffSearchInput" oninput="filterStaffApplications()" placeholder="Search applicants..."
                                    class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm w-64">
                                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                    <div id="staffApplicationsList" class="space-y-3"></div>
                    <div id="staffEmptyState" class="hidden text-center py-12">
                        <div class="text-6xl text-gray-300 mb-4">üë•</div>
                        <h3 class="text-lg font-medium text-gray-600">No applications found</h3>
                    </div>
                    <div id="staffPagination" class="flex items-center justify-between mt-6 pt-6 border-t border-gray-100">
                        <span class="text-sm text-gray-500" id="staffPaginationInfo">Showing 0-0 of 0</span>
                        <div class="flex gap-2" id="staffPaginationBtns"></div>
                    </div>
                </div>

                <div id="logTab" class="hidden bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h2 class="text-xl font-bold">Activity Log</h2>
                            <p class="text-sm text-gray-500">Last 200 activities</p>
                        </div>
                        <div class="flex gap-3">
                            <select id="logActionFilter" onchange="filterActivityLog()"
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm">
                                <option value="all">All Actions</option>
                                <option value="view">View</option>
                                <option value="status_update">Status Update</option>
                                <option value="delete">Delete</option>
                                <option value="upload">Upload</option>
                                <option value="note">Note</option>
                                <option value="assign">Assign</option>
                                <option value="edit">Edit</option>
                            </select>
                            <div class="relative">
                                <input type="text" id="logSearchInput" oninput="filterActivityLog()" placeholder="Search logs..."
                                    class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm w-64">
                                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <button onclick="loadActivityLog()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition text-sm">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div id="activityLogList" class="space-y-2 max-h-[600px] overflow-y-auto"></div>
                </div>
            </div>

        </div>
    </main>
</div>

<!-- ===== NEW APPLICATION MODAL ===== -->
<div id="newAppModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
        <div class="p-6 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-xl font-bold">New Application</h3>
            <button onclick="closeNewAppModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        <div class="p-6 overflow-y-auto flex-1">
            <div id="newAppError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm"></div>
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                        <input type="text" id="newAppName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email Address *</label>
                        <input type="email" id="newAppEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number *</label>
                        <input type="tel" id="newAppPhone" placeholder="+1 (555) 000-0000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Package *</label>
                        <select id="newAppPackage" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none">
                            <option value="">Select package...</option>
                            <option>Canada PR</option>
                            <option>USA Skilled Worker</option>
                            <option>Student Visa</option>
                            <option>UK Work Permit</option>
                            <option>Australia PR</option>
                            <option>Schengen Visa</option>
                            <option>Other</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Documents</label>
                    <div id="dropZone" onclick="document.getElementById('newAppDocs').click()"
                        ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)"
                        class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-emerald-500 transition cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-600 mb-1">Drag & drop files or click to browse</p>
                        <p class="text-xs text-gray-400">PDF, JPG, PNG, DOC, DOCX (Max 10MB each)</p>
                        <input type="file" id="newAppDocs" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="hidden" onchange="handleNewAppDocs(event)">
                    </div>
                    <div id="newAppDocsList" class="mt-4 space-y-2"></div>
                </div>
            </div>
        </div>
        <div class="p-6 border-t border-gray-200 flex justify-end gap-3">
            <button onclick="closeNewAppModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium">Cancel</button>
            <button onclick="createApplication()" id="submitNewAppBtn"
                class="px-6 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg transition font-medium flex items-center gap-2">
                <span>Submit Application</span><i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<!-- ===== DETAIL MODAL ===== -->
<div id="detailModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
        <div class="p-6 border-b border-gray-200 flex items-center justify-between bg-gray-50">
            <div>
                <h3 class="text-xl font-bold" id="detailTitle">Application Details</h3>
                <p class="text-sm text-gray-500 mt-1" id="detailSubtitle"></p>
            </div>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-200 rounded-lg transition">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="overflow-y-auto flex-1 p-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">

                    <!-- App Info -->
                    <div class="bg-gray-50 rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-bold">Application Information</h4>
                            <span id="detailStatus" class="px-3 py-1 rounded-full text-xs font-semibold"></span>
                        </div>
                        <div id="appInfoView" class="grid grid-cols-2 gap-4"></div>
                        <div id="appInfoEdit" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                        <button onclick="saveApplicationEdits()" id="editBtn"
                            class="hidden mt-4 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                            <i class="fas fa-save mr-1"></i> Save Changes
                        </button>
                    </div>

                    <!-- Staff Assignment -->
                    <div id="staffAssignSection" class="hidden bg-blue-50 rounded-xl p-6 border border-blue-100">
                        <h4 class="font-bold mb-3">Assign to Staff</h4>
                        <select id="staffAssignSelect" onchange="assignStaff()"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">Unassigned</option>
                        </select>
                    </div>

                    <!-- Status Update -->
                    <div id="statusUpdateSection" class="hidden bg-emerald-50 rounded-xl p-6 border border-emerald-100">
                        <h4 class="font-bold mb-3">Update Status</h4>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="updateApplicationStatus('pending')" data-status="pending" class="status-btn px-4 py-2 bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 transition text-sm font-medium">Pending</button>
                            <button onclick="updateApplicationStatus('review')" data-status="review" class="status-btn px-4 py-2 bg-orange-100 text-orange-700 rounded-lg hover:bg-orange-200 transition text-sm font-medium">Review</button>
                            <button onclick="updateApplicationStatus('approved')" data-status="approved" class="status-btn px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-medium">Approved</button>
                            <button onclick="updateApplicationStatus('rejected')" data-status="rejected" class="status-btn px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-medium">Rejected</button>
                        </div>
                    </div>

                    <!-- Documents -->
                    <div class="bg-white border border-gray-200 rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-bold">Documents <span id="docCount" class="text-gray-500 font-normal">(0)</span></h4>
                            <div id="uploadZone" class="hidden">
                                <input type="file" id="detailDocUpload" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="hidden" onchange="handleFileUpload(event)">
                                <button onclick="document.getElementById('detailDocUpload').click()" class="text-emerald-600 hover:text-emerald-700 text-sm font-medium">
                                    <i class="fas fa-upload mr-1"></i> Upload
                                </button>
                            </div>
                        </div>
                        <div id="documentsList" class="space-y-2"></div>
                    </div>

                    <!-- Notes -->
                    <div class="bg-white border border-gray-200 rounded-xl p-6">
                        <h4 class="font-bold mb-4">Notes & Updates</h4>
                        <div id="notesList" class="space-y-3 max-h-64 overflow-y-auto mb-4"></div>
                        <div class="flex gap-2">
                            <textarea id="newNoteInput" rows="2" placeholder="Add a note..."
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none resize-none"></textarea>
                            <button onclick="addNote()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg transition">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-6">
                    <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-6 border border-purple-100">
                        <h4 class="font-bold text-purple-800 mb-3">Referral Information</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Referral Code:</span>
                                <code class="font-mono font-bold text-purple-700" id="detailReferralCode">-</code>
                            </div>
                            <div id="referredBySection" class="hidden pt-2 border-t border-purple-200">
                                <span class="text-gray-600">Referred by:</span>
                                <button onclick="viewReferrerProfile()" id="referrerLink" class="block mt-1 text-purple-700 hover:text-purple-800 font-medium">View Referrer</button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-6">
                        <h4 class="font-bold mb-4">Actions</h4>
                        <div class="space-y-2">
                            <button onclick="closeModal()" class="w-full px-4 py-2 border border-gray-300 rounded-lg hover:bg-white transition text-sm">Close</button>
                            <button onclick="deleteApplication()" id="deleteAppBtn"
                                class="hidden w-full px-4 py-2 bg-red-50 text-red-600 border border-red-200 rounded-lg hover:bg-red-100 transition text-sm font-medium">
                                <i class="fas fa-trash-alt mr-2"></i>Delete Application
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===== REFERRER MODAL ===== -->
<div id="referrerModal" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-md p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold">Referrer Profile</h3>
            <button onclick="document.getElementById('referrerModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>
        <div id="referrerContent"></div>
    </div>
</div>

<!-- ===== TOAST ===== -->
<div id="toast" class="hidden fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-[70] flex items-center gap-3">
    <i id="toastIcon" class="fas fa-check-circle text-emerald-400"></i>
    <span id="toastMessage">Success!</span>
</div>

<script>
// ==================== CONFIG ====================
const SUPABASE_URL = 'https://lveejxxuvwikbitdbmbw.supabase.co';
const SUPABASE_KEY = 'sb_publishable_5wqWoM5FlCNJDNRhxgMFdA_9vzgwd6U';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ==================== STATE ====================
let currentUser = null;
let currentProfile = null;
let selectedAppId = null;
let allApplications = [];
let allStaffMembers = [];
let allLogs = [];
let isSignupMode = false;
let tempUploadedDocs = [];
let currentPage = 1;
let staffPage = 1;
let currentStaffTab = 'applicants';
const PER_PAGE = 10;
const STAFF_PER_PAGE = 15;

// ==================== HELPERS ====================
const $ = id => document.getElementById(id);
const sanitize = str => str ? String(str).replace(/[<>]/g, '') : '';
const fmtDate = s => s ? new Date(s).toLocaleDateString('en-US', { year:'numeric', month:'short', day:'numeric' }) : 'N/A';
const greeting = () => { const h = new Date().getHours(); return h<12?'Good morning':h<18?'Good afternoon':'Good evening'; };

function hl(text, q) {
    if (!q || !text) return sanitize(text);
    return sanitize(text).replace(new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi'), '<mark>$1</mark>');
}

function toast(msg, type='success') {
    $('toastMessage').textContent = msg;
    $('toastIcon').className = type==='error' ? 'fas fa-exclamation-circle text-red-400' : 'fas fa-check-circle text-emerald-400';
    $('toast').classList.remove('hidden');
    setTimeout(() => $('toast').classList.add('hidden'), 3500);
}

function genCode() {
    const c = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    return Array.from({length:8}, () => c[Math.floor(Math.random()*c.length)]).join('');
}

// ==================== AUTH ====================
function togglePw(id, iconId) {
    const inp = $(id);
    inp.type = inp.type==='password' ? 'text' : 'password';
    $(iconId).className = inp.type==='password' ? 'fas fa-eye' : 'fas fa-eye-slash';
}

function toggleAuthMode() {
    isSignupMode = !isSignupMode;
    $('signupFields').classList.toggle('hidden', !isSignupMode);
    $('authBtnText').textContent = isSignupMode ? 'Create Account' : 'Sign In';
    $('authToggleBtn').textContent = isSignupMode ? 'Already have an account? Sign in' : 'Create Account';
    $('authEmail').value = '';
    $('authPassword').value = '';
    $('authError').classList.add('hidden');
}

function showAuthErr(msg) {
    $('authError').textContent = msg;
    $('authError').classList.remove('hidden');
}

$('authForm').addEventListener('submit', async e => {
    e.preventDefault();
    const btn = $('authSubmitBtn');
    const orig = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    try {
        if (isSignupMode) await handleSignup();
        else await handleLogin();
    } finally {
        btn.disabled = false;
        btn.innerHTML = orig;
    }
});

async function handleSignup() {
    const email    = $('authEmail').value.trim();
    const password = $('authPassword').value;
    const confirm  = $('authConfirmPassword').value;
    const question = $('securityQuestion').value;
    const answer   = $('securityAnswer').value.trim();
    const refCode  = $('referralCode').value.trim().toUpperCase();

    if (password !== confirm)  { showAuthErr('Passwords do not match'); return; }
    if (password.length < 6)   { showAuthErr('Password must be at least 6 characters'); return; }
    if (!question)             { showAuthErr('Please select a security question'); return; }
    if (!answer)               { showAuthErr('Please provide a security answer'); return; }

    // Validate referral code if provided
    if (refCode) {
        const { data: ref } = await supabase.from('profiles').select('id').eq('referral_code', refCode).single();
        if (!ref) { showAuthErr('Invalid referral code'); return; }
    }

    // Sign up
    const { data: authData, error: authError } = await supabase.auth.signUp({ email, password });

    if (authError) {
        const msg = authError.message.toLowerCase();
        if (msg.includes('already registered') || msg.includes('already exists')) {
            showAuthErr('This email is already registered. Please sign in instead.');
        } else {
            showAuthErr(authError.message);
        }
        return;
    }

    // Supabase returns identities:[] when user already exists
    if (!authData.user || authData.user.identities?.length === 0) {
        showAuthErr('This email is already registered. Please sign in instead.');
        return;
    }

    const newCode  = genCode();
    const hashed   = CryptoJS.SHA256(answer.toLowerCase().trim()).toString();
    const fullName = email.split('@')[0].replace(/[._]/g,' ').replace(/\b\w/g, l=>l.toUpperCase());

    // Upsert profile (safe against duplicates)
    const { error: profileError } = await supabase.from('profiles').upsert([{
        id: authData.user.id,
        full_name: fullName,
        email: email,
        role: 'applicant',
        referral_code: newCode,
        referred_by_code: refCode || null,
        security_question: question,
        security_answer_hash: hashed
    }], { onConflict: 'id', ignoreDuplicates: true });

    if (profileError) { showAuthErr('Error creating profile: ' + profileError.message); return; }

    toast('Account created! You can now sign in.');
    toggleAuthMode();
}

async function handleLogin() {
    const email    = $('authEmail').value.trim();
    const password = $('authPassword').value;
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) { showAuthErr(error.message); return; }
    await bootApp(data.user);
}

async function handleLogout() {
    await supabase.auth.signOut();
    location.reload();
}

// ==================== BOOT ====================
async function bootApp(user) {
    currentUser = user;

    const { data: profile } = await supabase.from('profiles').select('*').eq('id', user.id).single();
    if (!profile) { showAuthErr('Profile not found. Please contact support.'); await supabase.auth.signOut(); return; }

    currentProfile = profile;
    $('authScreen').classList.add('hidden');
    $('mainApp').classList.remove('hidden');

    const name = profile.full_name || user.email.split('@')[0];
    $('sidebarName').textContent = name;
    $('sidebarRole').textContent = profile.role;
    $('userAvatar').textContent  = name.charAt(0).toUpperCase();
    $('headerEmail').textContent = user.email;
    $('heroName').textContent    = name.split(' ')[0];
    $('greetingText').textContent = greeting() + ',';

    const hr = $('headerRole');
    hr.textContent = profile.role;
    hr.className = `px-3 py-1 rounded-full text-xs font-semibold capitalize ${
        profile.role==='admin' ? 'bg-red-100 text-red-700' :
        profile.role==='staff' ? 'bg-blue-100 text-blue-700' :
        'bg-emerald-100 text-emerald-700'}`;

    if (profile.role === 'staff' || profile.role === 'admin') {
        $('navStaff').classList.remove('hidden');
        $('newAppBtn').classList.add('hidden');
        $('newAppBtn2').classList.add('hidden');
        $('referralCard').classList.add('hidden');
        await loadStaffMembers();
    } else {
        $('referralCard').classList.remove('hidden');
        $('referralCodeDisplay').textContent = profile.referral_code || '--------';
    }

    await loadAllApplications();
    renderDashboard();
    showSection('dashboard');
}

// ==================== DATA ====================
async function loadAllApplications() {
    let q = supabase.from('applications').select('*').order('created_at', { ascending: false });
    if (currentProfile.role === 'applicant') q = q.eq('user_id', currentUser.id);
    else if (currentProfile.role === 'staff') q = q.eq('assigned_staff_id', currentUser.id);

    const { data, error } = await q;
    if (error) { toast('Error loading applications: ' + error.message, 'error'); return; }
    allApplications = data || [];

    if ((currentProfile.role === 'staff' || currentProfile.role === 'admin') && allApplications.length) {
        const ids = [...new Set(allApplications.map(a => a.user_id).filter(Boolean))];
        const { data: profiles } = await supabase.from('profiles')
            .select('id, full_name, email, referral_code, referred_by_code, role').in('id', ids);
        if (profiles?.length) {
            const map = {};
            profiles.forEach(p => { map[p.id] = p; });
            allApplications = allApplications.map(a => ({ ...a, profiles: map[a.user_id] || null }));
        }
    }
}

async function loadStaffMembers() {
    const { data } = await supabase.from('profiles').select('id, full_name, email, role').in('role', ['staff','admin']);
    allStaffMembers = data || [];
}

async function loadDocuments(appId) {
    const { data } = await supabase.from('application_documents').select('*')
        .eq('application_id', appId).order('created_at', { ascending: false });
    return data || [];
}

async function loadNotes(appId) {
    const { data } = await supabase.from('notes')
        .select('*, profiles:user_id (full_name, role)')
        .eq('application_id', appId).order('created_at', { ascending: true });
    return data || [];
}

async function loadActivityLog() {
    const { data } = await supabase.from('activity_logs').select('*')
        .order('created_at', { ascending: false }).limit(200);
    allLogs = data || [];
    renderActivityLog();
}

// ==================== DASHBOARD ====================
function renderDashboard() {
    const total    = allApplications.length;
    const approved = allApplications.filter(a => a.status==='approved').length;
    const pending  = allApplications.filter(a => a.status==='pending').length;
    const rejected = allApplications.filter(a => a.status==='rejected').length;
    const review   = allApplications.filter(a => a.status==='review').length;

    $('metricTotal').textContent    = total;
    $('metricApproved').textContent = approved;
    $('metricPending').textContent  = pending;
    $('metricRejected').textContent = rejected;

    if (total > 0) {
        $('progressApproved').style.width = (approved/total*100)+'%';
        $('progressPending').style.width  = (pending/total*100)+'%';
        $('progressRejected').style.width = (rejected/total*100)+'%';
    }

    const rate = total > 0 ? Math.round(approved/total*100) : 0;
    $('approvalRate').textContent      = rate+'%';
    $('approvalProgress').style.width  = rate+'%';
    $('activeAppsCount').textContent   = `${pending+review} active application${(pending+review)!==1?'s':''}`;

    $('recentAppsList').innerHTML = allApplications.slice(0,5).map(a => `
        <div onclick="openApplicationModal('${a.id}')"
            class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition border border-gray-100">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center font-bold text-sm">
                    ${sanitize(a.applicant_name).charAt(0).toUpperCase()}
                </div>
                <div>
                    <p class="font-medium">${sanitize(a.applicant_name)}</p>
                    <p class="text-xs text-gray-500">${sanitize(a.package)} ‚Ä¢ ${fmtDate(a.created_at)}</p>
                </div>
            </div>
            <span class="px-3 py-1 rounded-full text-xs font-semibold status-${a.status}">
                ${a.status.charAt(0).toUpperCase()+a.status.slice(1)}
            </span>
        </div>`).join('') || '<p class="text-gray-500 text-center py-4">No applications yet</p>';
}

// ==================== APPLICATIONS LIST ====================
function getFiltered() {
    const q = $('searchInput').value.trim().toLowerCase();
    const s = $('statusFilter').value;
    return allApplications.filter(a =>
        (s==='all'||a.status===s) &&
        (!q || a.applicant_name.toLowerCase().includes(q) ||
               (a.email&&a.email.toLowerCase().includes(q)) ||
               (a.phone&&a.phone.includes(q)) ||
               (a.package&&a.package.toLowerCase().includes(q))));
}

function getStaffFiltered() {
    const q = $('staffSearchInput').value.trim().toLowerCase();
    const s = $('staffStatusFilter').value;
    return allApplications.filter(a => {
        const p = a.profiles||{};
        return (s==='all'||a.status===s) &&
            (!q || a.applicant_name.toLowerCase().includes(q) ||
                   (a.email&&a.email.toLowerCase().includes(q)) ||
                   (a.phone&&a.phone.includes(q)) ||
                   (a.package&&a.package.toLowerCase().includes(q)) ||
                   (p.email&&p.email.toLowerCase().includes(q)));
    });
}

function renderApplicationsGrid() {
    const filtered = getFiltered();
    const total = filtered.length;
    const start = (currentPage-1)*PER_PAGE;
    const items = filtered.slice(start, start+PER_PAGE);
    const pages = Math.ceil(total/PER_PAGE);
    const q     = $('searchInput').value.trim();

    $('appsCount').textContent = total;
    if (!items.length) {
        $('applicationsList').innerHTML = '';
        $('emptyState').classList.remove('hidden');
        $('pagination').classList.add('hidden');
        return;
    }
    $('emptyState').classList.add('hidden');
    $('pagination').classList.remove('hidden');
    $('applicationsList').innerHTML = items.map(a => `
        <div onclick="openApplicationModal('${a.id}')"
            class="flex items-center justify-between p-4 bg-white border border-gray-200 rounded-xl hover:border-emerald-500 hover:shadow-md cursor-pointer transition card-hover">
            <div class="flex items-center gap-4">
                <div class="text-xs font-mono text-gray-400 bg-gray-100 px-2 py-1 rounded">#${a.id.toString().slice(-4).toUpperCase()}</div>
                <div>
                    <p class="font-medium">${hl(a.applicant_name,q)}</p>
                    <p class="text-xs text-gray-500">${hl(a.package,q)} ‚Ä¢ ${fmtDate(a.created_at)}</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span class="w-2 h-2 rounded-full ${a.status==='approved'?'bg-green-500':a.status==='rejected'?'bg-red-500':a.status==='review'?'bg-orange-500':'bg-yellow-500'}"></span>
                <span class="px-3 py-1 rounded-full text-xs font-semibold status-${a.status}">${a.status.charAt(0).toUpperCase()+a.status.slice(1)}</span>
                <i class="fas fa-chevron-right text-gray-400"></i>
            </div>
        </div>`).join('');
    $('paginationInfo').textContent = `Showing ${start+1}-${Math.min(start+PER_PAGE,total)} of ${total}`;
    renderPages(pages, 'paginationBtns', 'goPage', currentPage);
}

function renderStaffApplicants() {
    const filtered = getStaffFiltered();
    const total = filtered.length;
    const start = (staffPage-1)*STAFF_PER_PAGE;
    const items = filtered.slice(start, start+STAFF_PER_PAGE);
    const pages = Math.ceil(total/STAFF_PER_PAGE);
    const q = $('staffSearchInput').value.trim();

    $('staffAppsCount').textContent = total;
    $('staffViewTitle').textContent = currentProfile.role==='admin' ? 'All Applicants' : 'My Assigned Applications';

    if (!items.length) {
        $('staffApplicationsList').innerHTML = '';
        $('staffEmptyState').classList.remove('hidden');
        $('staffPagination').classList.add('hidden');
        return;
    }
    $('staffEmptyState').classList.add('hidden');
    $('staffPagination').classList.remove('hidden');
    $('staffApplicationsList').innerHTML = items.map(a => {
        const p = a.profiles||{};
        return `
        <div onclick="openApplicationModal('${a.id}')"
            class="flex items-center justify-between p-4 bg-white border border-gray-200 rounded-xl hover:border-emerald-500 hover:shadow-md cursor-pointer transition card-hover">
            <div class="flex items-center gap-4">
                <div class="text-xs font-mono text-gray-400 bg-gray-100 px-2 py-1 rounded">#${a.id.toString().slice(-4).toUpperCase()}</div>
                <div>
                    <p class="font-medium">${hl(a.applicant_name,q)}</p>
                    <p class="text-xs text-gray-500">${p.email||a.email||''} ‚Ä¢ ${hl(a.package,q)}</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-xs text-gray-500">${fmtDate(a.created_at)}</span>
                <span class="px-3 py-1 rounded-full text-xs font-semibold status-${a.status}">${a.status.charAt(0).toUpperCase()+a.status.slice(1)}</span>
            </div>
        </div>`;
    }).join('');
    $('staffPaginationInfo').textContent = `Showing ${start+1}-${Math.min(start+STAFF_PER_PAGE,total)} of ${total}`;
    renderPages(pages, 'staffPaginationBtns', 'goStaffPage', staffPage);
}

function renderPages(total, containerId, fn, current) {
    if (total<=1) { $(containerId).innerHTML=''; return; }
    let h = `<button onclick="${fn}(${current-1})" ${current===1?'disabled':''} class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 text-sm"><i class="fas fa-chevron-left"></i></button>`;
    for (let i=1;i<=total;i++) {
        if (i===1||i===total||(i>=current-1&&i<=current+1))
            h += `<button onclick="${fn}(${i})" class="px-3 py-1 border ${i===current?'bg-emerald-600 text-white border-emerald-600':'border-gray-300 hover:bg-gray-50'} rounded text-sm min-w-[32px]">${i}</button>`;
        else if (i===current-2||i===current+2) h += `<span class="px-2 text-gray-400">...</span>`;
    }
    h += `<button onclick="${fn}(${current+1})" ${current===total?'disabled':''} class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 text-sm"><i class="fas fa-chevron-right"></i></button>`;
    $(containerId).innerHTML = h;
}

function renderActivityLog() {
    const q = $('logSearchInput').value.trim().toLowerCase();
    const f = $('logActionFilter').value;
    const filtered = allLogs.filter(l =>
        (f==='all'||l.action===f) &&
        (!q||(l.staff_email&&l.staff_email.toLowerCase().includes(q))||
              (l.detail&&l.detail.toLowerCase().includes(q))));
    $('activityLogList').innerHTML = filtered.map(l => `
        <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg border-l-4 log-${l.action}">
            <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                    <span class="font-medium text-sm">${sanitize(l.staff_email)}</span>
                    <span class="px-2 py-0.5 bg-gray-200 text-gray-700 rounded text-xs capitalize">${l.action.replace('_',' ')}</span>
                </div>
                <p class="text-sm text-gray-600">${sanitize(l.detail)}</p>
                <p class="text-xs text-gray-400 mt-1">${fmtDate(l.created_at)} ‚Ä¢ ${new Date(l.created_at).toLocaleTimeString()}</p>
            </div>
        </div>`).join('') || '<p class="text-center text-gray-500 py-8">No activity logs found</p>';
}

// ==================== FILTERS ====================
function filterApplications() {
    currentPage = 1;
    $('clearSearchBtn').classList.toggle('hidden', !$('searchInput').value.trim());
    renderApplicationsGrid();
}
function filterStaffApplications() { staffPage=1; renderStaffApplicants(); }
function filterActivityLog() { renderActivityLog(); }
function clearSearch() { $('searchInput').value=''; filterApplications(); }
function goPage(p) { currentPage=p; renderApplicationsGrid(); scrollTo(0,0); }
function goStaffPage(p) { staffPage=p; renderStaffApplicants(); scrollTo(0,0); }

// ==================== NAVIGATION ====================
function showSection(name) {
    ['dashboard','applications','staff'].forEach(s => {
        $(s+'Section').classList.add('hidden');
        $('nav'+s.charAt(0).toUpperCase()+s.slice(1)).classList.remove('bg-white/10');
    });
    $(name+'Section').classList.remove('hidden');
    $('nav'+name.charAt(0).toUpperCase()+name.slice(1)).classList.add('bg-white/10');
    const titles = { dashboard:'Dashboard', applications:'Applications', staff:'Staff Portal' };
    $('pageTitle').textContent = titles[name];
    if (name==='dashboard') renderDashboard();
    else if (name==='applications') renderApplicationsGrid();
    else if (name==='staff') { currentStaffTab==='applicants' ? renderStaffApplicants() : loadActivityLog(); }
}

function switchStaffTab(tab) {
    currentStaffTab = tab;
    const active = 'px-6 py-2 rounded-md text-sm font-medium bg-white text-emerald-700 shadow-sm';
    const inactive = 'px-6 py-2 rounded-md text-sm font-medium text-gray-600 hover:text-gray-800';
    $('tabApplicants').className = tab==='applicants' ? active : inactive;
    $('tabLog').className        = tab==='log'        ? active : inactive;
    $('applicantsTab').classList.toggle('hidden', tab!=='applicants');
    $('logTab').classList.toggle('hidden', tab!=='log');
    tab==='applicants' ? renderStaffApplicants() : loadActivityLog();
}

// ==================== NEW APPLICATION ====================
function openNewAppModal() {
    $('newAppModal').classList.remove('hidden');
    tempUploadedDocs = [];
    renderDocList();
    $('newAppName').value = $('newAppEmail').value = $('newAppPhone').value = '';
    $('newAppPackage').value = '';
    $('newAppError').classList.add('hidden');
}
function closeNewAppModal() { $('newAppModal').classList.add('hidden'); tempUploadedDocs=[]; }
function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('drag-active'); }
function handleDragLeave(e) { e.currentTarget.classList.remove('drag-active'); }
function handleDrop(e) { e.preventDefault(); e.currentTarget.classList.remove('drag-active'); addFiles(Array.from(e.dataTransfer.files)); }
function handleNewAppDocs(e) { addFiles(Array.from(e.target.files)); }

function addFiles(files) {
    const valid = ['.pdf','.jpg','.jpeg','.png','.doc','.docx'];
    tempUploadedDocs.push(...files.filter(f => valid.includes('.'+f.name.split('.').pop().toLowerCase()) && f.size<=10*1024*1024));
    renderDocList();
}

function renderDocList() {
    $('newAppDocsList').innerHTML = tempUploadedDocs.map((f,i) => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex items-center gap-3">
                <i class="fas fa-file text-emerald-600"></i>
                <div>
                    <p class="text-sm font-medium truncate max-w-[200px]">${sanitize(f.name)}</p>
                    <p class="text-xs text-gray-500">${(f.size/1024/1024).toFixed(2)} MB</p>
                </div>
            </div>
            <button onclick="removeDoc(${i})" class="text-red-500 hover:text-red-700 p-1"><i class="fas fa-times"></i></button>
        </div>`).join('') || '<p class="text-sm text-gray-400 italic">No files selected</p>';
}

function removeDoc(i) { tempUploadedDocs.splice(i,1); renderDocList(); }

async function createApplication() {
    const name = $('newAppName').value.trim();
    const email = $('newAppEmail').value.trim();
    const phone = $('newAppPhone').value.trim();
    const pkg   = $('newAppPackage').value;

    if (!name||!email||!phone||!pkg) {
        $('newAppError').textContent = 'Please fill in all required fields';
        $('newAppError').classList.remove('hidden');
        return;
    }
    const btn = $('submitNewAppBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

    try {
        const { data: app, error } = await supabase.from('applications')
            .insert([{ user_id:currentUser.id, applicant_name:name, email, phone, package:pkg, status:'pending' }])
            .select().single();
        if (error) throw error;

        for (const f of tempUploadedDocs) {
            const path = `${app.id}/${Date.now()}_${f.name}`;
            const { error: ue } = await supabase.storage.from('documents').upload(path, f);
            if (ue) continue;
            await supabase.from('application_documents').insert([{
                application_id:app.id, document_type:f.name.split('.').pop().toLowerCase(),
                file_name:f.name, file_path:path, file_size:f.size, uploaded_by:currentUser.id
            }]);
        }
        await logAct('upload', app.id, `Created application for ${name}`);
        toast('Application submitted!');
        closeNewAppModal();
        await loadAllApplications();
        if (!$('dashboardSection').classList.contains('hidden')) renderDashboard();
        else if (!$('applicationsSection').classList.contains('hidden')) renderApplicationsGrid();
    } catch(e) {
        $('newAppError').textContent = e.message;
        $('newAppError').classList.remove('hidden');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span>Submit Application</span><i class="fas fa-paper-plane"></i>';
    }
}

// ==================== DETAIL MODAL ====================
async function openApplicationModal(appId) {
    selectedAppId = appId;
    const app = allApplications.find(a => a.id===appId);
    if (!app) return;

    if (currentProfile.role !== 'applicant') await logAct('view', appId, `Viewed #${appId.toString().slice(-4)}`);

    $('detailTitle').textContent   = `#${app.id.toString().slice(-4).toUpperCase()} ‚Äî ${app.applicant_name}`;
    $('detailSubtitle').textContent = `Submitted on ${fmtDate(app.created_at)}`;

    const statusEl = $('detailStatus');
    statusEl.textContent = app.status.charAt(0).toUpperCase()+app.status.slice(1);
    statusEl.className = `px-3 py-1 rounded-full text-xs font-semibold status-${app.status}`;

    const isStaff   = ['staff','admin'].includes(currentProfile.role);
    const isAdmin   = currentProfile.role === 'admin';
    const isOwner   = currentProfile.role === 'applicant' && app.user_id === currentUser.id;
    const canEdit   = isAdmin || (isStaff && app.assigned_staff_id===currentUser.id) || isOwner;
    const refLocked = isOwner && !!currentProfile.referred_by_code;

    // Info section
    if (canEdit) {
        $('appInfoView').classList.add('hidden');
        $('appInfoEdit').classList.remove('hidden');
        $('appInfoEdit').innerHTML = `
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Applicant Name</label>
                <input type="text" id="editName" value="${sanitize(app.applicant_name)}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 outline-none">
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Email</label>
                <input type="email" id="editEmail" value="${sanitize(app.email)}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 outline-none">
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Phone</label>
                <input type="tel" id="editPhone" value="${sanitize(app.phone||'')}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 outline-none">
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Package</label>
                <select id="editPackage" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 outline-none">
                    ${['Canada PR','USA Skilled Worker','Student Visa','UK Work Permit','Australia PR','Schengen Visa','Other']
                        .map(p=>`<option ${app.package===p?'selected':''}>${p}</option>`).join('')}
                </select>
            </div>
            ${isOwner ? `<div class="md:col-span-2">
                <label class="block text-xs font-medium text-gray-600 mb-1">
                    Referral Code
                    <span class="ml-1 text-xs ${refLocked?'text-red-500':'text-emerald-600'}">
                        ${refLocked?'(already used ‚Äî locked)':'(one-time use only)'}
                    </span>
                </label>
                <input type="text" id="editReferralCode" value="${sanitize(currentProfile.referred_by_code||'')}"
                    maxlength="8" style="text-transform:uppercase" ${refLocked?'disabled':''}
                    placeholder="${refLocked?'Already set and locked':'Enter referral code (optional)'}"
                    class="w-full px-3 py-2 border ${refLocked?'border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed':'border-gray-300'} rounded-lg text-sm font-mono outline-none">
            </div>` : ''}`;
        $('editBtn').classList.remove('hidden');
    } else {
        $('appInfoView').classList.remove('hidden');
        $('appInfoEdit').classList.add('hidden');
        $('appInfoView').innerHTML = `
            <div><p class="text-xs text-gray-500 mb-1">Applicant Name</p><p class="font-medium">${sanitize(app.applicant_name)}</p></div>
            <div><p class="text-xs text-gray-500 mb-1">Email</p><p class="font-medium">${sanitize(app.email)}</p></div>
            <div><p class="text-xs text-gray-500 mb-1">Phone</p><p class="font-medium">${sanitize(app.phone||'N/A')}</p></div>
            <div><p class="text-xs text-gray-500 mb-1">Package</p><p class="font-medium">${sanitize(app.package)}</p></div>`;
        $('editBtn').classList.add('hidden');
    }

    // Staff assign (admin only)
    if (isAdmin) {
        $('staffAssignSection').classList.remove('hidden');
        $('staffAssignSelect').innerHTML = '<option value="">Unassigned</option>' +
            allStaffMembers.map(s => `<option value="${s.id}" ${s.id===app.assigned_staff_id?'selected':''}>${sanitize(s.full_name)} (${s.role})</option>`).join('');
    } else {
        $('staffAssignSection').classList.add('hidden');
    }

    // Status update (staff/admin only)
    if (isStaff) {
        $('statusUpdateSection').classList.remove('hidden');
        document.querySelectorAll('.status-btn').forEach(b => {
            b.classList.remove('ring-2','ring-offset-2','ring-emerald-500');
            if (b.dataset.status===app.status) b.classList.add('ring-2','ring-offset-2','ring-emerald-500');
        });
    } else {
        $('statusUpdateSection').classList.add('hidden');
    }

    // Documents
    const docs = await loadDocuments(appId);
    $('docCount').textContent = `(${docs.length})`;
    $('documentsList').innerHTML = docs.map(d => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex items-center gap-3">
                <i class="fas fa-file-${getIcon(d.document_type)} text-emerald-600"></i>
                <div>
                    <p class="text-sm font-medium">${sanitize(d.file_name)}</p>
                    <p class="text-xs text-gray-500">${(d.file_size/1024).toFixed(1)} KB ‚Ä¢ ${fmtDate(d.created_at)}</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="dlFile('${d.file_path}','${sanitize(d.file_name)}')" class="text-emerald-600 hover:text-emerald-700 p-2 hover:bg-emerald-50 rounded">
                    <i class="fas fa-download"></i>
                </button>
                ${isStaff?`<button onclick="delDoc('${d.id}','${d.file_path}')" class="text-red-500 hover:text-red-700 p-2 hover:bg-red-50 rounded"><i class="fas fa-trash"></i></button>`:''}
            </div>
        </div>`).join('') || '<p class="text-sm text-gray-500 italic">No documents uploaded</p>';

    (isStaff||isOwner) ? $('uploadZone').classList.remove('hidden') : $('uploadZone').classList.add('hidden');

    // Notes ‚Äî visible to everyone
    const notes = await loadNotes(appId);
    $('notesList').innerHTML = notes.length ? notes.map(n => `
        <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
            <div class="flex items-center justify-between mb-1">
                <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${
                    n.profiles?.role==='admin'?'bg-red-100 text-red-700':
                    n.profiles?.role==='staff'?'bg-blue-100 text-blue-700':'bg-emerald-100 text-emerald-700'}">
                    ${sanitize(n.profiles?.full_name)||'System'}
                </span>
                <span class="text-xs text-gray-400">${fmtDate(n.created_at)}</span>
            </div>
            <p class="text-sm text-gray-800 mt-1">${sanitize(n.content)}</p>
        </div>`).join('') : '<p class="text-sm text-gray-500 italic text-center py-3">No notes yet</p>';

    $('newNoteInput').placeholder = isOwner ? 'Send a message to staff...' : 'Add a note...';

    // Referral
    const rp = app.profiles || currentProfile;
    $('detailReferralCode').textContent = rp.referral_code || currentProfile.referral_code || 'N/A';
    const refBy = rp.referred_by_code || currentProfile.referred_by_code;
    if (refBy) {
        $('referredBySection').classList.remove('hidden');
        $('referrerLink').dataset.code = refBy;
    } else {
        $('referredBySection').classList.add('hidden');
    }

    $('deleteAppBtn').classList.toggle('hidden', !isStaff);
    $('detailModal').classList.remove('hidden');
}

function getIcon(t) {
    if (t==='pdf') return 'pdf';
    if (['jpg','jpeg','png'].includes(t)) return 'image';
    if (['doc','docx'].includes(t)) return 'word';
    return 'alt';
}

function closeModal() { $('detailModal').classList.add('hidden'); selectedAppId=null; }

async function saveApplicationEdits() {
    if (!selectedAppId) return;
    const btn = $('editBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Saving...';

    try {
        const { error } = await supabase.from('applications').update({
            applicant_name: $('editName').value.trim(),
            email:  $('editEmail').value.trim(),
            phone:  $('editPhone').value.trim(),
            package: $('editPackage').value
        }).eq('id', selectedAppId);

        if (error) { toast('Error saving: '+error.message, 'error'); return; }

        // One-time referral code
        if (currentProfile.role==='applicant' && !currentProfile.referred_by_code) {
            const inp = $('editReferralCode');
            if (inp) {
                const code = inp.value.trim().toUpperCase();
                if (code) {
                    const { data: ref } = await supabase.from('profiles').select('id').eq('referral_code',code).single();
                    if (!ref) { toast('Invalid referral code','error'); return; }
                    if (ref.id===currentUser.id) { toast('Cannot use your own referral code','error'); return; }
                    const { error: re } = await supabase.from('profiles').update({ referred_by_code:code }).eq('id',currentUser.id);
                    if (!re) { currentProfile.referred_by_code=code; toast('Referral code applied and locked!'); }
                }
            }
        }

        await logAct('edit', selectedAppId, 'Updated application details');
        toast('Changes saved!');
        await loadAllApplications();
        openApplicationModal(selectedAppId);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save mr-1"></i> Save Changes';
    }
}

async function updateApplicationStatus(status) {
    if (!selectedAppId) return;
    const app = allApplications.find(a=>a.id===selectedAppId);
    const { error } = await supabase.from('applications').update({ status }).eq('id',selectedAppId);
    if (error) { toast('Error updating status','error'); return; }
    await logAct('status_update', selectedAppId, `Changed status from ${app.status} to ${status}`);
    toast(`Status updated to ${status}`);
    await loadAllApplications();
    openApplicationModal(selectedAppId);
}

async function assignStaff() {
    if (!selectedAppId) return;
    const sid = $('staffAssignSelect').value;
    const { error } = await supabase.from('applications').update({ assigned_staff_id:sid||null }).eq('id',selectedAppId);
    if (error) { toast('Error assigning staff','error'); return; }
    const sname = sid ? allStaffMembers.find(s=>s.id===sid)?.full_name||'Staff' : 'Unassigned';
    await logAct('assign', selectedAppId, `Assigned to ${sname}`);
    toast(`Assigned to ${sname}`);
    await loadAllApplications();
    openApplicationModal(selectedAppId);
}

async function deleteApplication() {
    if (!selectedAppId) return;
    if (!confirm('Delete this application? This cannot be undone.')) return;
    await logAct('delete', selectedAppId, `Deleted #${selectedAppId.toString().slice(-4)}`);
    const { data: docs } = await supabase.from('application_documents').select('file_path').eq('application_id',selectedAppId);
    for (const d of docs||[]) await supabase.storage.from('documents').remove([d.file_path]);
    const { error } = await supabase.from('applications').delete().eq('id',selectedAppId);
    if (error) { toast('Error deleting','error'); return; }
    toast('Application deleted');
    closeModal();
    await loadAllApplications();
    if (!$('dashboardSection').classList.contains('hidden')) renderDashboard();
    if (!$('applicationsSection').classList.contains('hidden')) renderApplicationsGrid();
    if (!$('staffSection').classList.contains('hidden')) renderStaffApplicants();
}

// ==================== DOCUMENTS ====================
async function handleFileUpload(e) {
    if (!selectedAppId) return;
    const uploaded = [];
    for (const f of Array.from(e.target.files)) {
        const path = `${selectedAppId}/${Date.now()}_${f.name}`;
        const { error } = await supabase.storage.from('documents').upload(path, f);
        if (error) continue;
        await supabase.from('application_documents').insert([{
            application_id:selectedAppId, document_type:f.name.split('.').pop().toLowerCase(),
            file_name:f.name, file_path:path, file_size:f.size, uploaded_by:currentUser.id
        }]);
        uploaded.push(f.name);
    }
    if (uploaded.length) {
        await logAct('upload', selectedAppId, `Uploaded ${uploaded.length} file(s): ${uploaded.join(', ')}`);
        toast('Files uploaded!');
        openApplicationModal(selectedAppId);
    }
    e.target.value = '';
}

async function dlFile(path, name) {
    const { data, error } = await supabase.storage.from('documents').download(path);
    if (error) { toast('Download failed','error'); return; }
    const url = URL.createObjectURL(data);
    const a = document.createElement('a');
    a.href=url; a.download=name;
    document.body.appendChild(a); a.click();
    document.body.removeChild(a); URL.revokeObjectURL(url);
}

async function delDoc(id, path) {
    if (!confirm('Delete this document?')) return;
    await supabase.storage.from('documents').remove([path]);
    await supabase.from('application_documents').delete().eq('id',id);
    toast('Document deleted');
    openApplicationModal(selectedAppId);
}

// ==================== NOTES ====================
async function addNote() {
    const content = $('newNoteInput').value.trim();
    if (!content||!selectedAppId) return;
    const { error } = await supabase.from('notes').insert([{ application_id:selectedAppId, user_id:currentUser.id, content }]);
    if (error) { toast('Error adding note: '+error.message,'error'); return; }
    await logAct('note', selectedAppId, `Note: ${content.substring(0,50)}`);
    $('newNoteInput').value = '';
    toast('Note added');
    openApplicationModal(selectedAppId);
}

// ==================== LOGGING ====================
async function logAct(action, appId, detail) {
    try {
        await supabase.from('activity_logs').insert([{
            staff_user_id:currentUser.id, staff_email:currentUser.email,
            application_id:appId, action, detail
        }]);
    } catch(e) { console.warn('Log failed:', e); }
}

// ==================== REFERRAL ====================
function copyReferralCode() {
    navigator.clipboard.writeText($('referralCodeDisplay').textContent).then(() => toast('Copied!'));
}

async function viewReferrerProfile() {
    const code = $('referrerLink').dataset.code;
    if (!code) return;
    const { data: r } = await supabase.from('profiles').select('full_name,email,created_at,referral_code').eq('referral_code',code).single();
    if (!r) { toast('Referrer not found','error'); return; }
    const { count } = await supabase.from('profiles').select('id',{count:'exact'}).eq('referred_by_code',code);
    $('referrerContent').innerHTML = `
        <div class="text-center mb-4">
            <div class="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center text-2xl font-bold mx-auto mb-3">
                ${sanitize(r.full_name).charAt(0).toUpperCase()}
            </div>
            <h4 class="font-bold text-lg">${sanitize(r.full_name)}</h4>
            <p class="text-sm text-gray-500">${sanitize(r.email||'')}</p>
        </div>
        <div class="space-y-3 text-sm">
            <div class="flex justify-between py-2 border-b border-gray-100">
                <span class="text-gray-600">Member Since</span><span class="font-medium">${fmtDate(r.created_at)}</span>
            </div>
            <div class="flex justify-between py-2 border-b border-gray-100">
                <span class="text-gray-600">Referral Code</span>
                <code class="font-mono bg-gray-100 px-2 py-1 rounded">${sanitize(r.referral_code)}</code>
            </div>
            <div class="flex justify-between py-2">
                <span class="text-gray-600">Total Referrals</span>
                <span class="font-bold text-emerald-600">${count||0}</span>
            </div>
        </div>`;
    $('referrerModal').classList.remove('hidden');
}

// ==================== INIT ====================
window.addEventListener('load', async () => {
    const { data: { session } } = await supabase.auth.getSession();
    if (session) await bootApp(session.user);
    supabase.auth.onAuthStateChange(event => { if (event==='SIGNED_OUT') location.reload(); });
});

document.addEventListener('keydown', e => {
    if (e.key==='Escape') {
        closeModal();
        closeNewAppModal();
        $('referrerModal').classList.add('hidden');
    }
});
</script>
</body>
</html>